<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Programma Giornaliero Trasformazione Frutta - Layout Tabellare</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<style>
* {
   margin: 0;
   padding: 0;
   box-sizing: border-box;
}

body { 
   font-family: 'Arial', sans-serif;
   font-size: 18px;
   line-height: 1.4;
   color: #000000;
   margin: 20px;
   background-color: #f5f5f5;
}

.header {
   text-align: center;
   margin-bottom: 20px;
   background: #1e3c72;
   border: 2px solid #000000;
   padding: 15px;
   border-radius: 10px;
   color: #ffffff;
}

.header h1 {
   font-size: 28px;
   margin-bottom: 8px;
   font-weight: bold;
   color: #ffffff;
}

.header .subtitle {
   font-size: 22px;
   margin-bottom: 8px;
   color: #ffffff;
}

.header-info {
   display: flex;
   justify-content: space-around;
   margin-top: 12px;
   font-size: 18px;
   color: #ffffff;
}

.controls-section {
   background-color: #e9ecef;
   border: 1px solid #000000;
   border-radius: 8px;
   padding: 15px;
   margin-bottom: 20px;
   display: flex;
   gap: 20px;
   align-items: center;
   flex-wrap: wrap;
}

.controls-section .form-group {
   display: flex;
   flex-direction: column;
   min-width: 200px;
}

.controls-section label {
   font-weight: bold;
   margin-bottom: 5px;
   color: #000000;
   font-size: 16px;
}

.controls-section .form-control,
.controls-section .form-select {
   border: 1px solid #000000;
   border-radius: 5px;
   padding: 8px;
   font-size: 16px;
}

.btn {
   padding: 10px 18px;
   border: none;
   border-radius: 6px;
   font-weight: bold;
   cursor: pointer;
   text-decoration: none;
   display: inline-block;
   margin: 4px;
   font-size: 14px;
}

.btn-primary {
   background: #1e3c72;
   color: white;
}

.btn-success {
   background: #28a745;
   color: white;
}

.btn-warning {
   background: #ffc107;
   color: #000000;
}

.btn-danger {
   background: #dc3545;
   color: white;
}

.btn-info {
   background: #17a2b8;
   color: white;
}

.totals-section {
   display: flex;
   justify-content: space-around;
   margin-bottom: 20px;
   background-color: #ffc107;
   padding: 15px;
   border: 1px solid #000000;
   border-radius: 8px;
}

.total-item {
   text-align: center;
   color: #000000;
}

.total-value {
   font-size: 26px;
   font-weight: bold;
   color: #000000;
}

.total-label {
   font-size: 16px;
   margin-top: 4px;
   color: #000000;
}

/* LAYOUT PRINCIPALE - 4 COLONNE x 2 RIGHE PER PAGINA */
.main-grid {
   display: grid;
   grid-template-columns: repeat(4, 1fr);
   grid-template-rows: auto auto;
   gap: 15px;
   margin-bottom: 20px;
   min-height: 75vh;
   page-break-after: always;
}

/* POSIZIONI SPECIFICHE PER LE 8 CARD PER PAGINA */
.card-position-1 { grid-column: 1; grid-row: 1; }
.card-position-2 { grid-column: 1; grid-row: 2; }
.card-position-3 { grid-column: 2; grid-row: 1; }
.card-position-4 { grid-column: 2; grid-row: 2; }
.card-position-5 { grid-column: 3; grid-row: 1; }
.card-position-6 { grid-column: 3; grid-row: 2; }
.card-position-7 { grid-column: 4; grid-row: 1; }
.card-position-8 { grid-column: 4; grid-row: 2; }

.supplier-card {
   background-color: #e9ecef;
   border: 2px solid #000000;
   border-radius: 10px;
   padding: 12px;
   min-height: 480px;
   max-height: 480px;
   overflow-y: auto;
}

.destination-card {
   background-color: #f0f8ff;
   border: 2px solid #007bff;
   border-radius: 10px;
   padding: 12px;
   min-height: 380px;
   max-height: 380px;
   overflow-y: auto;
}

/* COMBINAZIONI COLORI */
.supplier-card.combination-verde {
   background-color: #d4edda;
   border: 2px solid #28a745;
}

.supplier-card.combination-azzurro {
   background-color: #d1ecf1;
   border: 2px solid #17a2b8;
}

.supplier-card.combination-viola {
   background-color: #e2e3f3;
   border: 2px solid #6f42c1;
}

.card-header {
   background: #6c757d;
   color: #ffffff;
   padding: 8px;
   text-align: center;
   font-weight: bold;
   font-size: 18px;
   margin: -12px -12px 12px -12px;
   border-radius: 8px 8px 0 0;
}

.card-header.combination-verde {
   background: #28a745;
}

.card-header.combination-azzurro {
   background: #17a2b8;
}

.card-header.combination-viola {
   background: #6f42c1;
}

.dest-card-header {
   background: #007bff;
   color: #ffffff;
   padding: 8px;
   text-align: center;
   font-weight: bold;
   font-size: 18px;
   margin: -12px -12px 12px -12px;
   border-radius: 8px 8px 0 0;
}

.form-row {
   display: flex;
   justify-content: space-between;
   margin-bottom: 8px;
   align-items: center;
}

.form-label {
   font-weight: bold;
   color: #000000;
   width: 40%;
   font-size: 14px;
}

.form-input {
   width: 58%;
}

.form-input input,
.form-input select,
.form-input textarea {
   width: 100%;
   border: 1px solid #000000;
   border-radius: 5px;
   padding: 4px;
   font-size: 13px;
}

.form-input textarea {
   min-height: 45px;
   resize: vertical;
}

.calculated-field {
   background-color: #e7f3ff;
   font-weight: bold;
   text-align: center;
}

.yield-result {
   background-color: #e8f5e8;
   font-weight: bold;
   text-align: center;
}

.bio-red-field {
   color: #dc3545 !important;
   font-weight: bold;
   border-color: #dc3545 !important;
}

.bio-black-field {
   color: #000000 !important;
   font-weight: bold;
   border-color: #495057 !important;
}

.bio-red-text {
   color: #dc3545 !important;
   font-weight: bold;
}

.bio-black-text {
   color: #000000 !important;
   font-weight: bold;
}

.combination-result {
   background-color: #fff3cd !important;
   border: 2px solid #ffc107 !important;
   font-weight: bold;
   color: #856404 !important;
}

.received-transfer {
   background-color: #d4edda !important;
   border: 2px solid #28a745 !important;
}

.section-divider {
   border-bottom: 1px solid #6c757d;
   margin: 8px 0;
}

.remaining-qty {
   background-color: #e7f3ff;
   border: 1px solid #2a5298;
   padding: 5px;
   border-radius: 4px;
   font-weight: bold;
   text-align: center;
   color: #1e3c72;
   font-size: 12px;
   margin: 8px 0;
}

.transfer-section {
   background-color: #fff3cd;
   border: 1px solid #ffc107;
   border-radius: 4px;
   padding: 8px;
   margin-top: 8px;
}

.transfer-row {
   display: flex;
   align-items: center;
   gap: 5px;
   flex-wrap: wrap;
}

.transfer-row select {
   flex: 1;
   min-width: 70px;
   font-size: 11px;
   padding: 3px;
}

.transfer-row input {
   width: 45px;
   font-size: 11px;
   padding: 3px;
}

.transfer-row .btn {
   padding: 3px 8px;
   font-size: 10px;
   margin: 0;
}

.card-buttons {
   margin-top: 10px;
   text-align: center;
}

.card-buttons .btn {
   padding: 4px 10px;
   font-size: 11px;
   margin: 3px;
}

.hidden-field {
   display: none;
}

.combination-details {
   font-size: 11px;
   color: #856404;
   margin-top: 4px;
   background-color: #fff3cd;
   padding: 5px;
   border-radius: 4px;
   border: 1px solid #ffc107;
   line-height: 1.3;
}

.transfer-details {
   font-size: 11px;
   color: #000000;
   margin-top: 4px;
   background-color: #d4edda;
   padding: 4px;
   border-radius: 4px;
   border: 1px solid #28a745;
}

.provenienza-info {
   background-color: #e8f5e8;
   border: 1px solid #28a745;
   padding: 5px;
   border-radius: 4px;
   font-size: 11px;
   color: #155724;
   margin-bottom: 8px;
}

.save-status {
   background-color: #d4edda;
   border: 1px solid #28a745;
   color: #155724;
   padding: 10px;
   border-radius: 5px;
   margin-bottom: 15px;
   text-align: center;
   display: none;
}

.save-error {
   background-color: #f8d7da;
   border: 1px solid #dc3545;
   color: #721c24;
}

/* SEZIONI COMBINAZIONI */
.combination-section {
   background-color: #f8f9fa;
   border: 1px solid #000000;
   border-radius: 8px;
   padding: 15px;
   margin-bottom: 20px;
}

.combination-group {
   background-color: #f0f8ff;
   border: 2px solid #007bff;
   border-radius: 10px;
   padding: 15px;
   margin-bottom: 15px;
}

.combination-group-b {
   background-color: #f0fff0;
   border: 2px solid #28a745;
   border-radius: 10px;
   padding: 15px;
   margin-bottom: 15px;
}

.combination-group-c {
   background-color: #f3f0ff;
   border: 2px solid #6f42c1;
   border-radius: 10px;
   padding: 15px;
   margin-bottom: 15px;
}

/* MODAL SELEZIONE FORNITORE */
.modal-backdrop {
   position: fixed;
   top: 0;
   left: 0;
   width: 100%;
   height: 100%;
   background-color: rgba(0,0,0,0.5);
   display: none;
   z-index: 1000;
}

.modal-content {
   position: fixed;
   top: 50%;
   left: 50%;
   transform: translate(-50%, -50%);
   background-color: white;
   padding: 20px;
   border-radius: 8px;
   border: 2px solid #000;
   min-width: 300px;
   z-index: 1001;
}

.modal-header {
   margin-bottom: 15px;
   text-align: center;
   font-weight: bold;
   font-size: 18px;
}

.modal-body {
   margin-bottom: 15px;
}

.modal-footer {
   text-align: center;
}

/* SEZIONE RIEPILOGO SUCCO 2ª E TORCHIATO */
.summary-section {
   background-color: #f8f9fa;
   border: 2px solid #000000;
   border-radius: 8px;
   padding: 15px;
   margin-bottom: 20px;
   display: none; /* Nascosto di default, mostrato solo se necessario */
}

.summary-row {
   display: grid;
   grid-template-columns: 1fr 1fr;
   gap: 20px;
   margin-bottom: 15px;
}

.summary-card {
   background-color: #fff3cd;
   border: 2px solid #ffc107;
   border-radius: 8px;
   padding: 15px;
}

.torchiato-card-summary {
   background-color: #f8d7da;
   border: 2px solid #dc3545;
   border-radius: 8px;
   padding: 15px;
}

.summary-card-header {
   background: #ffc107;
   color: #000000;
   padding: 8px;
   text-align: center;
   font-weight: bold;
   font-size: 18px;
   margin: -15px -15px 15px -15px;
   border-radius: 6px 6px 0 0;
}

.torchiato-card-header {
   background: #dc3545;
   color: #ffffff;
   padding: 8px;
   text-align: center;
   font-weight: bold;
   font-size: 18px;
   margin: -15px -15px 15px -15px;
   border-radius: 6px 6px 0 0;
}

/* TABELLA DI STAMPA */
.print-table {
   display: none;
}

/* STILI STAMPA - LAYOUT TABELLARE */
@media print {
   body { 
       margin: 8mm !important;
       background-color: white !important;
       font-size: 10px !important;
   }
   
   .controls-section,
   .combination-section,
   .main-grid,
   .summary-section {
       display: none !important;
   }
   
   .btn {
       display: none !important;
   }
   
   .header {
       background: #1e3c72 !important;
       color: #ffffff !important;
       border: 2px solid #000000 !important;
       margin-bottom: 15px !important;
       page-break-inside: avoid;
   }
   
   .print-table {
       display: table !important;
       width: 100%;
       border-collapse: collapse;
       margin-bottom: 20px;
       page-break-inside: avoid;
   }
   
   .print-table th {
       background-color: #1e3c72 !important;
       color: #ffffff !important;
       border: 1px solid #000000 !important;
       padding: 6px 4px !important;
       text-align: center !important;
       font-size: 9px !important;
       font-weight: bold !important;
       vertical-align: middle !important;
   }
   
   .print-table td {
       border: 1px solid #000000 !important;
       padding: 4px 3px !important;
       vertical-align: middle !important;
       font-size: 9px !important;
       text-align: center !important;
   }
   
   .print-table td.text-left {
       text-align: left !important;
   }
   
   .print-table tr.combination-verde {
       background-color: #d4edda !important;
   }
   
   .print-table tr.combination-azzurro {
       background-color: #d1ecf1 !important;
   }
   
   .print-table tr.combination-viola {
       background-color: #e2e3f3 !important;
   }
   
   .print-table td.bio-red {
       color: #dc3545 !important;
       font-weight: bold !important;
   }
   
   .print-table td.bio-black {
       color: #000000 !important;
       font-weight: bold !important;
   }
   
   .print-summary-section {
       display: block !important;
       margin-top: 20px;
       page-break-inside: avoid;
   }
   
   .print-summary-row {
       display: flex !important;
       gap: 20px;
       margin-bottom: 15px;
   }
   
   .print-summary-card {
       flex: 1;
       border: 2px solid #000000 !important;
       border-radius: 8px;
       padding: 10px;
       background-color: #f8f9fa !important;
   }
   
   .print-summary-header {
       font-weight: bold;
       text-align: center;
       margin-bottom: 10px;
       font-size: 12px;
       padding: 5px;
       background-color: #e9ecef !important;
       border-radius: 4px;
   }
   
   .print-summary-row-item {
       display: flex;
       justify-content: space-between;
       margin-bottom: 5px;
       font-size: 10px;
   }
   
   .print-summary-value {
       font-weight: bold;
   }
   
   @page {
       margin: 10mm;
       size: A4 landscape;
   }
}

/* PAGINAZIONE AUTOMATICA */
.page-break {
   page-break-before: always;
}

/* CARD IN ATTESA DI POSIZIONAMENTO */
.card-summary-pending {
   opacity: 0.7;
}
</style>
</head>

<body>
   <div class="header">
       <h1>PROGRAMMA GIORNALIERO TRASFORMAZIONE FRUTTA</h1>
       <div class="subtitle">Sistema di Gestione Produzione - Simone Gatto</div>
       <div class="header-info">
           <div><strong>Data:</strong> <span id="current-date"></span></div>
           <div><strong>Agrume:</strong> <span id="selected-agrume">N/D</span></div>
           <div><strong>Elementi:</strong> <span id="elements-count">0</span></div>
           <div><strong>Pagine:</strong> <span id="pages-count">0</span></div>
       </div>
       <div style="margin-top: 8px; font-size: 16px;">
           <strong>Generato:</strong> <span id="last-revision"></span>
       </div>
   </div>

   <!-- Status salvataggio -->
   <div id="save-status" class="save-status">
       <span id="save-message"></span>
   </div>

   <!-- Sezione Controlli -->
   <div class="controls-section">
       <div class="form-group">
           <label for="tipo-agrume">Tipo di Agrume</label>
           <select class="form-select" id="tipo-agrume">
               <option value="">Seleziona agrume</option>
               <option value="LIMONE">Limone</option>
               <option value="ARANCIA">Arancia</option>
               <option value="MANDARINO">Mandarino</option>
               <option value="POMPELMO">Pompelmo</option>
               <option value="BERGAMOTTO">Bergamotto</option>
           </select>
       </div>
       
       <div class="form-group">
           <label for="data-lavorazione">Data Lavorazione</label>
           <input type="date" class="form-control" id="data-lavorazione">
       </div>
       
       <div>
           <button type="button" class="btn btn-primary" id="aggiungi-fornitore">
               <i class="bi bi-plus-circle"></i> Aggiungi Fornitore
           </button>
           <button type="button" class="btn btn-success" id="aggiungi-destinazione">
               <i class="bi bi-plus-square"></i> Aggiungi Destinazione
           </button>
           <button type="button" class="btn btn-info" id="salva-file">
               <i class="bi bi-download"></i> Salva File
           </button>
           <button type="button" class="btn btn-info" id="carica-file">
               <i class="bi bi-upload"></i> Carica File
           </button>
           <button type="button" class="btn btn-warning" onclick="window.print()">
               <i class="bi bi-printer"></i> Stampa
           </button>
           <button type="button" class="btn btn-danger" id="reset-tutto">
               <i class="bi bi-arrow-clockwise"></i> Reset
           </button>
       </div>
   </div>

   <!-- Sezione Totali -->
   <div class="totals-section">
       <div class="total-item">
           <div class="total-value" id="entrata-totale">0</div>
           <div class="total-label">Kg Entrata</div>
       </div>
       <div class="total-item">
           <div class="total-value" id="trasformata-totale">0</div>
           <div class="total-label">Kg Trasformati</div>
       </div>
       <div class="total-item">
           <div class="total-value" id="giacenza-totale">0</div>
           <div class="total-label">Kg Giacenza</div>
       </div>
   </div>

   <!-- Sezione Combinazioni -->
   <div id="combinazioni-section" class="combination-section hidden-field">
       <h3 style="margin-bottom: 15px; color: #1e3c72;"><i class="bi bi-diagram-3"></i> Selezione Combinazioni Fornitori</h3>
       
       <div class="combination-group">
           <h5><i class="bi bi-diagram-2"></i> Combinazione Verde - Succo 1ª</h5>
           <div style="margin-bottom: 10px;">
               <select class="form-select" id="combinazione-fornitori-verde" style="width: 100%; margin-bottom: 10px;">
                   <option value="">Seleziona combinazione Verde</option>
               </select>
               <button type="button" class="btn btn-success" id="applica-combinazione-verde">
                   <i class="bi bi-check-circle"></i> Applica Verde
               </button>
               <button type="button" class="btn btn-warning" id="reset-combinazione-verde">
                   <i class="bi bi-x-circle"></i> Reset Verde
               </button>
           </div>
       </div>
       
       <div class="combination-group-b">
           <h5><i class="bi bi-diagram-3"></i> Combinazione Azzurro - Succo 1ª</h5>
           <div style="margin-bottom: 10px;">
               <select class="form-select" id="combinazione-fornitori-azzurro" style="width: 100%; margin-bottom: 10px;">
                   <option value="">Seleziona combinazione Azzurro</option>
               </select>
               <button type="button" class="btn btn-info" id="applica-combinazione-azzurro">
                   <i class="bi bi-check-circle"></i> Applica Azzurro
               </button>
               <button type="button" class="btn btn-warning" id="reset-combinazione-azzurro">
                   <i class="bi bi-x-circle"></i> Reset Azzurro
               </button>
           </div>
       </div>

       <div class="combination-group-c">
           <h5><i class="bi bi-diagram-3"></i> Combinazione Viola - Succo 1ª</h5>
           <div>
               <select class="form-select" id="combinazione-fornitori-viola" style="width: 100%; margin-bottom: 10px;">
                   <option value="">Seleziona combinazione Viola</option>
               </select>
               <button type="button" class="btn" style="background: #6f42c1; color: white;" id="applica-combinazione-viola">
                   <i class="bi bi-check-circle"></i> Applica Viola
               </button>
               <button type="button" class="btn btn-warning" id="reset-combinazione-viola">
                   <i class="bi bi-x-circle"></i> Reset Viola
               </button>
           </div>
       </div>
   </div>

   <!-- CONTAINER PRINCIPALE PER LE PAGINE -->
   <div id="pages-container">
       <!-- Le pagine verranno generate dinamicamente qui -->
   </div>

   <!-- Sezione Riepilogo Succo 2ª e Torchiato -->
   <div id="summary-section" class="summary-section">
       <div class="summary-row">
           <div class="summary-card" id="succo-seconda-summary">
               <div class="summary-card-header">TOTALE SUCCO 2ª</div>
               
               <div class="form-row">
                   <span class="form-label">Quantità Totale (kg):</span>
                   <div class="form-input">
                       <input type="number" class="totale-succo-seconda calculated-field" readonly>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Destinazione:</span>
                   <div class="form-input">
                       <select class="destinazione-totale-seconda">
                           <option value="NAT IN TINI" selected>NAT IN TINI</option>
                           <option value="CONCENTRATO">CONCENTRATO</option>
                           <option value="ALTRO">ALTRO</option>
                       </select>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Polpa:</span>
                   <div class="form-input">
                       <select class="tenore-polpa-seconda">
                           <option value="<1%" selected><1%</option>
                           <option value="STANDARD">STANDARD</option>
                           <option value="LIMPIDO">LIMPIDO</option>
                           <option value="ALTRO">ALTRO</option>
                       </select>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">°BX:</span>
                   <div class="form-input">
                       <select class="brix-seconda">
                           <option value="NAT" selected>NAT</option>
                           <option value="20">20</option>
                           <option value="32">32</option>
                           <option value="40">40</option>
                           <option value="45">45</option>
                           <option value="ALTRO">ALTRO</option>
                       </select>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Note:</span>
                   <div class="form-input">
                       <textarea class="note-seconda" rows="2">SERB. ESTERNI</textarea>
                   </div>
               </div>
           </div>

           <div class="torchiato-card-summary" id="torchiato-summary">
               <div class="torchiato-card-header">TOTALE TORCHIATO</div>
               
               <div class="form-row">
                   <span class="form-label">Quantità Totale (kg):</span>
                   <div class="form-input">
                       <input type="number" class="totale-torchiato calculated-field" readonly>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Destinazione:</span>
                   <div class="form-input">
                       <select class="destinazione-totale-torchiato">
                           <option value="CONCENTRATO" selected>CONCENTRATO</option>
                           <option value="NAT IN TINI">NAT IN TINI</option>
                           <option value="F.F.">F.F.</option>
                           <option value="ALTRO">ALTRO</option>
                       </select>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Polpa:</span>
                   <div class="form-input">
                       <select class="tenore-polpa-torchiato">
                           <option value="<1%" selected><1%</option>
                           <option value="STANDARD">STANDARD</option>
                           <option value="LIMPIDO">LIMPIDO</option>
                           <option value="ALTRO">ALTRO</option>
                       </select>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">°BX:</span>
                   <div class="form-input">
                       <select class="brix-torchiato">
                           <option value="45" selected>45</option>
                           <option value="NAT">NAT</option>
                           <option value="32">32</option>
                           <option value="40">40</option>
                           <option value="ALTRO">ALTRO</option>
                       </select>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Note:</span>
                   <div class="form-input">
                       <textarea class="note-torchiato" rows="2"></textarea>
                   </div>
               </div>
           </div>
       </div>
   </div>

   <!-- Tabella di stampa (nascosta di default, visibile solo in stampa) -->
   <table class="print-table">
       <thead>
           <tr>
               <th style="width: 8%;">LINEA</th>
               <th style="width: 12%;">NOME FORN.</th>
               <th style="width: 6%;">ENTRATA</th>
               <th style="width: 6%;">TRASF.</th>
               <th style="width: 6%;">GIACENZA</th>
               <th style="width: 8%;">CERT.</th>
               <th style="width: 8%;">VARIETÀ</th>
               <th style="width: 6%;">PORTATA</th>
               <th style="width: 5%;">INIZIO</th>
               <th style="width: 5%;">FINE</th>
               <th style="width: 6%;">Q. SUCCO 1ª</th>
               <th style="width: 8%;">DEST. SUCCO 1ª</th>
               <th style="width: 5%;">POLPA</th>
               <th style="width: 5%;">°BX</th>
               <th style="width: 4%;">BIO</th>
               <th style="width: 4%;">PAST.</th>
               <th style="width: 5%;">CONSERV.</th>
               <th style="width: 8%;">NOTE</th>
           </tr>
       </thead>
       <tbody id="print-table-body">
           <!-- Le righe verranno generate dinamicamente -->
       </tbody>
   </table>

   <!-- Sezione riepilogo per la stampa -->
   <div class="print-summary-section" style="display: none;">
       <div class="print-summary-row">
           <div class="print-summary-card" id="print-succo-seconda">
               <div class="print-summary-header">TOTALE SUCCO 2ª</div>
               <!-- Contenuto generato dinamicamente -->
           </div>
           
           <div class="print-summary-card" id="print-torchiato">
               <div class="print-summary-header">TOTALE TORCHIATO</div>
               <!-- Contenuto generato dinamicamente -->
           </div>
       </div>
   </div>

   <!-- Modal selezione fornitore per destinazione -->
   <div id="supplier-selection-modal" class="modal-backdrop">
       <div class="modal-content">
           <div class="modal-header">
               Seleziona Fornitore per Destinazione
           </div>
           <div class="modal-body">
               <label for="supplier-select" class="form-label">Scegli il fornitore di riferimento:</label>
               <select id="supplier-select" class="form-select">
                   <option value="">Seleziona fornitore</option>
               </select>
           </div>
           <div class="modal-footer">
               <button type="button" class="btn btn-success" id="confirm-supplier-selection">
                   Conferma
               </button>
               <button type="button" class="btn btn-secondary" id="cancel-supplier-selection">
                   Annulla
               </button>
           </div>
       </div>
   </div>

   <!-- Input file nascosto -->
   <input type="file" id="file-input" accept=".json" style="display: none;">

<script>
$(document).ready(function() {
   let fornitoriData = {};
   let destinazioniData = {};
   let transferData = {};
   let transferredAmounts = {};
   let provenienzaData = {};
   let combinationData = {
       verde: { indexes: [], details: [], totalCombination: 0 },
       azzurro: { indexes: [], details: [], totalCombination: 0 },
       viola: { indexes: [], details: [], totalCombination: 0 }
   };
   
   // Rese per linea di trasformazione
   const yieldsPerLine = {
       'BOE/1100': { prima: 33, seconda: 5.0, torchiato: 6.0 },
       'GOE EST/400': { prima: 31.60, seconda: 0, torchiato: 6.0 },
       '400': { prima: 32.00, seconda: 0, torchiato: 6.0 },
       'GOE EST/POLY': { prima: 30.60, seconda: 0, torchiato: 6.0 },
       'GOE INT/POLY': { prima: 28.30, seconda: 0, torchiato: 6.0 },
       'BIRILLATRICI': { prima: 26.60, seconda: 0, torchiato: 6.0 },
       'GOE EST/BIRILLATRICI': { prima: 25.60, seconda: 0, torchiato: 6.0 }
   };

   // Definizione varietà per ogni tipo di agrume
   const varietyOptions = {
       'LIMONE': ['VERDELLO', 'FEMMINELLO', 'INTERDONATO', 'BIANCHETTO', 'MONACHELLO', 'VARIE', 'ALTRO'],
       'MANDARINO': ['TARD. DI CIACULLI', 'AVANA', 'CLEMENTINO', 'VARIE', 'ALTRO'],
       'ARANCIA': ['BIONDA', 'ROSSA', 'MORO', 'SANGUINELLA', 'TAROCCO', 'VARIE', 'ALTRO'],
       'BERGAMOTTO': ['FEMMINELLO', 'CASTAGNARO', 'VARIE', 'ALTRO'],
       'POMPELMO': ['GIALLO', 'ROSA', 'VARIE', 'ALTRO']
   };

   // Inizializzazione
   function initApp() {
       const today = new Date();
       $('#current-date').text(today.toLocaleDateString('it-IT', {
           weekday: 'long',
           year: 'numeric',
           month: 'long',
           day: 'numeric'
       }));
       $('#data-lavorazione').val(today.toISOString().split('T')[0]);
       updateLastRevision();
       updateElementsCount();
       initializePagesContainer();
       checkSummaryVisibility();
   }

   function updateLastRevision() {
       const now = new Date();
       $('#last-revision').text(now.toLocaleDateString('it-IT') + ' - ' + now.toLocaleTimeString('it-IT'));
   }

   function updateElementsCount() {
       const count = $('.supplier-card, .destination-card').length;
       $('#elements-count').text(count);
       
       const pages = Math.ceil(count / 8) || 1;
       $('#pages-count').text(pages);
   }

   // Controlla se mostrare la sezione riepilogo
   function checkSummaryVisibility() {
       let showSummary = false;
       
       $('.supplier-card').each(function() {
           const linea = $(this).find('.linea').val();
           const trasformata = parseFloat($(this).find('.quantita-trasformata').val()) || 0;
           
           if (trasformata > 0 && (linea === 'BOE/1100' || linea)) {
               showSummary = true;
               return false; // break
           }
       });
       
       if (showSummary) {
           $('#summary-section').show();
           updateSummaryCards();
       } else {
           $('#summary-section').hide();
       }
   }

   // NUOVA: Inizializza il container delle pagine
   function initializePagesContainer() {
       $('#pages-container').empty();
       createNewPage();
   }

   // NUOVA: Crea una nuova pagina
   function createNewPage() {
       const pageNumber = $('.main-grid').length + 1;
       const newPage = `
           <div class="main-grid page-${pageNumber}" data-page="${pageNumber}">
               <!-- Le card verranno inserite qui dinamicamente -->
           </div>
       `;
       $('#pages-container').append(newPage);
       return pageNumber;
   }

   // NUOVA: Riorganizza le card con posizionamento prioritario
   function reorganizeCardsWithPriority() {
       // Raccogli tutte le card esistenti
       const allCards = $('.supplier-card, .destination-card').detach();
       
       // Separa le card per tipo
       const supplierCards = allCards.filter('.supplier-card');
       const destinationCards = allCards.filter('.destination-card');
       
       // Combina le card con priorità: fornitori prima, destinazioni dopo
       const orderedCards = [
           ...supplierCards.toArray(),
           ...destinationCards.toArray()
       ];
       
       // Pulisci tutte le pagine
       $('.main-grid').empty();
       
       // Distribuisci le card nelle pagine (8 per pagina)
       let currentPageIndex = 0;
       let currentPositionInPage = 0;
       
       orderedCards.forEach((card, index) => {
           // Se abbiamo riempito la pagina corrente, crea una nuova pagina
           if (currentPositionInPage >= 8) {
               currentPageIndex++;
               currentPositionInPage = 0;
           }
           
           // Se non esiste la pagina, creala
           if ($('.main-grid').length <= currentPageIndex) {
               createNewPage();
           }
           
           // Rimuovi tutte le classi di posizione precedenti
           $(card).removeClass('card-position-1 card-position-2 card-position-3 card-position-4 card-position-5 card-position-6 card-position-7 card-position-8');
           
           // Aggiungi la nuova classe di posizione
           $(card).addClass(`card-position-${currentPositionInPage + 1}`);
           
           // Aggiungi la card alla pagina corrente
           $(`.main-grid[data-page="${currentPageIndex + 1}"]`).append(card);
           
           currentPositionInPage++;
       });
       
       updateElementsCount();
   }

   // MODIFICATA: Funzione per ottenere la prima posizione libera (ora illimitata)
   function getNextAvailablePosition() {
       const totalCards = $('.supplier-card, .destination-card').length;
       const currentPageIndex = Math.floor(totalCards / 8);
       const positionInPage = totalCards % 8;
       
       // Se la pagina corrente è piena, crea una nuova pagina
       if (positionInPage === 0 && totalCards > 0) {
           createNewPage();
       }
       
       return {
           pageIndex: currentPageIndex,
           position: positionInPage + 1
       };
   }

   // MODIFICATA: Funzione per generare un numero fornitore progressivo
   function getNextSupplierNumber() {
       let maxSupplierNumber = 0;
       $('.supplier-card').each(function() {
           const supplierNumber = parseInt($(this).data('supplier-number')) || 0;
           if (supplierNumber > maxSupplierNumber) {
               maxSupplierNumber = supplierNumber;
           }
       });
       return maxSupplierNumber + 1;
   }

   // MODIFICATA: Funzione per generare un cardIndex univoco
   function getNextCardIndex() {
       let maxIndex = 0;
       $('.supplier-card, .destination-card').each(function() {
           const cardIndex = parseInt($(this).data('card-index')) || 0;
           if (cardIndex > maxIndex) {
               maxIndex = cardIndex;
           }
       });
       return maxIndex + 1;
   }

   // NUOVA: Funzione per aggiornare le numerazioni delle destinazioni
   function updateDestinationHeaders() {
       $('.destination-card').each(function() {
           const cardIndex = $(this).data('card-index');
           const selectedSupplier = $(this).data('selected-supplier');
           
           if (selectedSupplier) {
               const supplierCard = $(`.supplier-card[data-card-index="${selectedSupplier}"]`);
               const supplierNumber = supplierCard.data('supplier-number') || selectedSupplier;
               
               let destCount = 0;
               $('.destination-card').each(function() {
                   const thisSupplier = $(this).data('selected-supplier');
                   const thisIndex = $(this).data('card-index');
                   if (thisSupplier === selectedSupplier && thisIndex <= cardIndex) {
                       destCount++;
                   }
               });
               
               $(this).find('.dest-card-header').text(`${destCount}ª Destinazione F${supplierNumber}`);
           } else {
               $(this).find('.dest-card-header').text('Destinazione non assegnata');
           }
       });
   }

   // NUOVA: Genera tabella per la stampa - CORRETTA CON VERA TABELLA HTML
   function generatePrintTable() {
       const tbody = $('#print-table-body');
       tbody.empty();
       
       // Ordina le card per numero fornitore
       const sortedCards = $('.supplier-card').toArray().sort((a, b) => {
           const numA = parseInt($(a).data('supplier-number')) || 0;
           const numB = parseInt($(b).data('supplier-number')) || 0;
           return numA - numB;
       });
       
       sortedCards.forEach(cardElement => {
           const card = $(cardElement);
           const cardIndex = card.data('card-index');
           const supplierNumber = card.data('supplier-number');
           
           // Determina colore combinazione
           let combinationClass = '';
           if (card.hasClass('combination-verde')) combinationClass = 'combination-verde';
           if (card.hasClass('combination-azzurro')) combinationClass = 'combination-azzurro';
           if (card.hasClass('combination-viola')) combinationClass = 'combination-viola';
           
           // Determina colori bio
           const cert = card.find('.certificazione').val();
           const bio = card.find('.bio-prima').val();
           const isBioSpecific = ['BIO EU', 'BIO DEM', 'BIO NTD', 'BIO DEM/NTD'].includes(cert);
           const isDeclassatoOrNo = bio === 'DECLASSATO' || bio === 'NO';
           
           let bioClass = '';
           if (isBioSpecific) {
               bioClass = isDeclassatoOrNo ? 'bio-black' : 'bio-red';
           }
           
           // Raccolta dati
           const linea = card.find('.linea').val() || '';
           const nome = card.find('.nome-fornitore').val();
           const altroNome = card.find('.altro-fornitore').val();
           const nomeFornitore = nome === 'ALTRO' ? altroNome : nome;
           const entrata = card.find('.quantita-entrata').val() || '0';
           const trasformata = card.find('.quantita-trasformata').val() || '0';
           const giacenza = card.find('.giacenza').val() || '0';
           const certificazione = card.find('.certificazione').val() || '';
           const varieta = card.find('.varieta').val();
           const altroVarieta = card.find('.altra-varieta').val();
           const varietaDisplay = varieta === 'ALTRO' ? altroVarieta : varieta;
           const portata = card.find('.portata').val() || '';
           const inizio = card.find('.orario-inizio').val() || '';
           const fine = card.find('.orario-fine').val() || '';
           const succo = card.find('.succo-prima').val() || '0';
           const destinazione = card.find('.destinazione-prima').val() || '';
           const polpa = card.find('.tenore-polpa-prima').val() || '';
           const brix = card.find('.brix-prima').val() || '';
           const bioStatus = card.find('.bio-prima').val() || '';
           const pastorizzato = card.find('.pastorizzato-prima').val() || '';
           const conservato = card.find('.conservato-prima').val() || '';
           const note = card.find('.note-prima').val() || '';
           
           const row = $(`
               <tr class="${combinationClass}">
                   <td class="${bioClass}">${linea}</td>
                   <td class="text-left ${bioClass}">F${supplierNumber} - ${nomeFornitore || ''}</td>
                   <td>${entrata}</td>
                   <td>${trasformata}</td>
                   <td>${giacenza}</td>
                   <td class="${bioClass}">${certificazione}</td>
                   <td class="${bioClass}">${varietaDisplay || ''}</td>
                   <td>${portata}</td>
                   <td>${inizio}</td>
                   <td>${fine}</td>
                   <td>${succo}</td>
                   <td class="${bioClass}">${destinazione}</td>
                   <td class="${bioClass}">${polpa}</td>
                   <td class="${bioClass}">${brix}</td>
                   <td class="${bioClass}">${bioStatus}</td>
                   <td class="${bioClass}">${pastorizzato}</td>
                   <td class="${bioClass}">${conservato}</td>
                   <td class="text-left">${note}</td>
               </tr>
           `);
           
           tbody.append(row);
       });
   }

   // NUOVA: Genera sezione riepilogo per la stampa
   function generatePrintSummary() {
       const succosecondaDiv = $('#print-succo-seconda');
       const torchiatoDiv = $('#print-torchiato');
       
       const totalSeconda = parseFloat($('.totale-succo-seconda').val()) || 0;
       const totalTorchiato = parseFloat($('.totale-torchiato').val()) || 0;
       
       // Succo 2ª
       if (totalSeconda > 0) {
           const destSeconda = $('.destinazione-totale-seconda').val() || 'NAT IN TINI';
           const polpaSeconda = $('.tenore-polpa-seconda').val() || '<1%';
           const brixSeconda = $('.brix-seconda').val() || 'NAT';
           const noteSeconda = $('.note-seconda').val() || 'SERB. ESTERNI';
           
           succosecondaDiv.html(`
               <div class="print-summary-header">TOTALE SUCCO 2ª</div>
               <div class="print-summary-row-item">
                   <span>Quantità Totale:</span>
                   <span class="print-summary-value">${totalSeconda.toFixed(1)} kg</span>
               </div>
               <div class="print-summary-row-item">
                   <span>Destinazione:</span>
                   <span>${destSeconda}</span>
               </div>
               <div class="print-summary-row-item">
                   <span>Polpa:</span>
                   <span>${polpaSeconda}</span>
               </div>
               <div class="print-summary-row-item">
                   <span>°BX:</span>
                   <span>${brixSeconda}</span>
               </div>
               <div class="print-summary-row-item">
                   <span>Note:</span>
                   <span>${noteSeconda}</span>
               </div>
           `);
       } else {
           succosecondaDiv.html('<div class="print-summary-header">SUCCO 2ª NON PRESENTE</div>');
       }
       
       // Torchiato
       if (totalTorchiato > 0) {
           const destTorchiato = $('.destinazione-totale-torchiato').val() || 'CONCENTRATO';
           const polpaTorchiato = $('.tenore-polpa-torchiato').val() || '<1%';
           const brixTorchiato = $('.brix-torchiato').val() || '45';
           const noteTorchiato = $('.note-torchiato').val() || '';
           
           torchiatoDiv.html(`
               <div class="print-summary-header">TOTALE TORCHIATO</div>
               <div class="print-summary-row-item">
                   <span>Quantità Totale:</span>
                   <span class="print-summary-value">${totalTorchiato.toFixed(1)} kg</span>
               </div>
               <div class="print-summary-row-item">
                   <span>Destinazione:</span>
                   <span>${destTorchiato}</span>
               </div>
               <div class="print-summary-row-item">
                   <span>Polpa:</span>
                   <span>${polpaTorchiato}</span>
               </div>
               <div class="print-summary-row-item">
                   <span>°BX:</span>
                   <span>${brixTorchiato}</span>
               </div>
               <div class="print-summary-row-item">
                   <span>Note:</span>
                   <span>${noteTorchiato || 'N/D'}</span>
               </div>
           `);
       } else {
           torchiatoDiv.html('<div class="print-summary-header">TORCHIATO NON PRESENTE</div>');
       }
   }

   // MODIFICATA: Override del window.print per preparare la stampa
   const originalPrint = window.print;
   window.print = function() {
       generatePrintTable();
       generatePrintSummary();
       originalPrint.call(window);
   };
   
   // MODIFICATA: Reset card
   window.resetCard = function(cardIndex) {
       if (confirm('Resettare tutti i campi di questa card?')) {
           const supplierCard = $(`.supplier-card[data-card-index="${cardIndex}"]`);
           const destCard = $(`.destination-card[data-card-index="${cardIndex}"]`);
           
           if (supplierCard.length > 0) {
               // Reset fornitore
               const supplierNumber = supplierCard.data('supplier-number');
               supplierCard.removeClass('combination-verde combination-azzurro combination-viola');
               supplierCard.find('.card-header').removeClass('combination-verde combination-azzurro combination-viola');
               
               // Rimuovi riferimenti dalle combinazioni
               ['verde', 'azzurro', 'viola'].forEach(color => {
                   const supplierIndex = combinationData[color].indexes.indexOf(cardIndex);
                   if (supplierIndex > -1) {
                       combinationData[color].indexes.splice(supplierIndex, 1);
                       combinationData[color].details = combinationData[color].details.filter(d => d.cardIndex !== cardIndex);
                       combinationData[color].totalCombination = 0;
                   }
               });
               
               // Reset quantità trasferite
               delete transferredAmounts[cardIndex];
               
               // Reset tutti i campi
               supplierCard.find('input, select, textarea').val('');
               supplierCard.find('.altro-fornitore, .altra-certificazione, .altra-varieta, .altra-destinazione').addClass('hidden-field');
               supplierCard.find('.succo-prima').removeClass('combination-result received-transfer');
               supplierCard.find('.transfer-details, .combination-details').addClass('hidden-field').html('');
               supplierCard.find('.card-header').text(`Fornitore ${supplierNumber}`);
               
               // Rimuovi dati trasferimenti
               delete transferData[cardIndex];
               
               updateBioStyle(cardIndex);
               
           } else if (destCard.length > 0) {
               // Reset destinazione
               destCard.find('input, select, textarea').val('');
               destCard.find('.altra-destinazione-text, .altro-tenore-text, .altro-brix-text').addClass('hidden-field');
               destCard.find('.bio').val('SI');
               destCard.find('.conservato').val('NO');
               
               // Reset provenienza
               delete provenienzaData[cardIndex];
               $(`#provenienza-${cardIndex}`).text('Nessuna provenienza');
               
               // Reset assegnazione fornitore
               destCard.removeData('selected-supplier');
               destCard.find('.dest-card-header').text('Destinazione non assegnata');
               
               updateDestBioStyles(cardIndex);
           }
           
           updateTotals();
           updateCombinazioneOptions();
           updateTransferOptions();
           updateDestinationHeaders();
           updateSummaryCards();
           checkSummaryVisibility();
           
           alert('Card resettata con successo!');
       }
   };

   // MODIFICATA: Rimuovi card con riorganizzazione automatica
   window.removeCard = function(cardIndex) {
       if (confirm('Rimuovere questa card?')) {
           // Rimuovi riferimenti dalle combinazioni
           ['verde', 'azzurro', 'viola'].forEach(color => {
               const supplierIndex = combinationData[color].indexes.indexOf(cardIndex);
               if (supplierIndex > -1) {
                   combinationData[color].indexes.splice(supplierIndex, 1);
                   combinationData[color].details = combinationData[color].details.filter(d => d.cardIndex !== cardIndex);
                   combinationData[color].totalCombination = 0;
               }
           });
           
           $(`.supplier-card[data-card-index="${cardIndex}"], .destination-card[data-card-index="${cardIndex}"]`).remove();
           
           // Rimuovi dati
           delete fornitoriData[cardIndex];
           delete destinazioniData[cardIndex];
           delete transferData[cardIndex];
           delete transferredAmounts[cardIndex];
           delete provenienzaData[cardIndex];
           
           // Rimuovi riferimenti a questa card dai trasferimenti di altri
           Object.keys(transferData).forEach(key => {
               transferData[key] = transferData[key].filter(transfer => 
                   transfer.fromCard !== cardIndex
               );
           });
           
           // Riorganizza automaticamente con priorità
           reorganizeCardsWithPriority();
           
           updateTotals();
           updateCombinazioneOptions();
           toggleCombinazioniSection();
           updateTransferOptions();
           updateDestinationHeaders();
           updateSummaryCards();
           checkSummaryVisibility();
       }
   };

   // Salvataggio e caricamento file
   function collectProgramData() {
       const data = {
           tipoAgrume: $('#tipo-agrume').val(),
           dataLavorazione: $('#data-lavorazione').val(),
           ultimaRevisione: $('#last-revision').text(),
           transferData: transferData,
           transferredAmounts: transferredAmounts,
           provenienzaData: provenienzaData,
           combinationData: combinationData,
           fornitoriData: fornitoriData,
           destinazioniData: destinazioniData,
           summaryData: {
               succoseconda: {
                   destinazione: $('.destinazione-totale-seconda').val(),
                   polpa: $('.tenore-polpa-seconda').val(),
                   brix: $('.brix-seconda').val(),
                   note: $('.note-seconda').val()
               },
               torchiato: {
                   destinazione: $('.destinazione-totale-torchiato').val(),
                   polpa: $('.tenore-polpa-torchiato').val(),
                   brix: $('.brix-torchiato').val(),
                   note: $('.note-torchiato').val()
               }
           },
           cards: []
       };
       
       // Raccolta dati fornitori
       $('.supplier-card').each(function() {
           const cardIndex = $(this).data('card-index');
           const supplierNumber = $(this).data('supplier-number');
           const receivedTransfers = transferData[cardIndex] || [];
           
           // Determina colore combinazione
           let combinationColor = '';
           ['verde', 'azzurro', 'viola'].forEach(color => {
               if ($(this).hasClass(`combination-${color}`)) {
                   combinationColor = color;
               }
           });
           
           const card = {
               cardIndex: cardIndex,
               cardType: 'supplier',
               supplierNumber: supplierNumber,
               nome: $(this).find('.nome-fornitore').val(),
               altroNome: $(this).find('.altro-fornitore').val(),
               quantitaEntrata: parseFloat($(this).find('.quantita-entrata').val()) || 0,
               quantitaTrasformata: parseFloat($(this).find('.quantita-trasformata').val()) || 0,
               giacenza: parseFloat($(this).find('.giacenza').val()) || 0,
               certificazione: $(this).find('.certificazione').val(),
               altraCertificazione: $(this).find('.altra-certificazione').val(),
               varieta: $(this).find('.varieta').val(),
               altraVarieta: $(this).find('.altra-varieta').val(),
               linea: $(this).find('.linea').val(),
               portata: parseFloat($(this).find('.portata').val()) || 0,
               orarioInizio: $(this).find('.orario-inizio').val(),
               orarioFine: $(this).find('.orario-fine').val(),
               succo: parseFloat($(this).find('.succo-prima').val()) || 0,
               destinazione: $(this).find('.destinazione-prima').val(),
               altraDestinazione: $(this).find('.altra-destinazione').val(),
               caratteristiche: {
                   tenorePolpa: $(this).find('.tenore-polpa-prima').val(),
                   brix: $(this).find('.brix-prima').val(),
                   bio: $(this).find('.bio-prima').val(),
                   pastorizzato: $(this).find('.pastorizzato-prima').val(),
                   conservato: $(this).find('.conservato-prima').val(),
                   note: $(this).find('.note-prima').val()
               },
               hasCombination: $(this).find('.succo-prima').hasClass('combination-result'),
               combinationType: $(this).find('.succo-prima').attr('data-combination-type') || '',
               combinationColor: combinationColor,
               combinationDetails: $(this).find('.combination-details').html() || '',
               hasReceivedTransfers: $(this).find('.succo-prima').hasClass('received-transfer'),
               receivedTransfers: receivedTransfers
           };
           
           data.cards.push(card);
       });
       
       // Raccolta dati destinazioni
       $('.destination-card').each(function() {
           const cardIndex = $(this).data('card-index');
           const selectedSupplier = $(this).data('selected-supplier');
           
           const card = {
               cardIndex: cardIndex,
               cardType: 'destination',
               selectedSupplier: selectedSupplier,
               quantitaPrima: parseFloat($(this).find('.quantita-prima-dest').val()) || 0,
               destinazione: $(this).find('.destinazione-succo').val(),
               altraDestinazioneText: $(this).find('.altra-destinazione-text').val(),
               caratteristiche: {
                   tenorePolpa: $(this).find('.tenore-polpa').val(),
                   altroTenoreText: $(this).find('.altro-tenore-text').val(),
                   brix: $(this).find('.brix').val(),
                   altroBrixText: $(this).find('.altro-brix-text').val(),
                   bio: $(this).find('.bio').val(),
                   pastorizzato: $(this).find('.pastorizzato').val(),
                   conservato: $(this).find('.conservato').val(),
                   note: $(this).find('.note').val()
               }
           };
           
           data.cards.push(card);
       });
       
       return data;
   }

   function saveToFile() {
       try {
           const data = collectProgramData();
           const dataString = JSON.stringify(data, null, 2);
           
           const today = new Date();
           const dateString = today.toISOString().split('T')[0];
           const agrume = data.tipoAgrume || 'programma';
           const filename = `programma_${agrume}_${dateString}.json`;
           
           if ('showSaveFilePicker' in window) {
               saveWithFileSystemAPI(dataString, filename);
           } else {
               saveWithDownloadFallback(dataString, filename);
           }
           
       } catch (error) {
           showSaveStatus('Errore durante la preparazione del file: ' + error.message, 'error');
       }
   }

   async function saveWithFileSystemAPI(dataString, filename) {
       try {
           const fileHandle = await window.showSaveFilePicker({
               suggestedName: filename,
               types: [{
                   description: 'File JSON',
                   accept: { 'application/json': ['.json'] }
               }]
           });
           
           const writable = await fileHandle.createWritable();
           await writable.write(dataString);
           await writable.close();
           
           showSaveStatus(`File ${filename} salvato con successo!`, 'success');
       } catch (error) {
           if (error.name !== 'AbortError') {
               showSaveStatus('Errore durante il salvataggio: ' + error.message, 'error');
               saveWithDownloadFallback(dataString, filename);
           }
       }
   }

   function saveWithDownloadFallback(dataString, filename) {
       const blob = new Blob([dataString], { type: 'application/json' });
       const url = URL.createObjectURL(blob);
       const a = document.createElement('a');
       a.href = url;
       a.download = filename;
       document.body.appendChild(a);
       a.click();
       document.body.removeChild(a);
       URL.revokeObjectURL(url);
       
       showSaveStatus(`File ${filename} salvato nella cartella Download!`, 'success');
   }

   function loadFromFile() {
       $('#file-input').click();
   }

   $('#file-input').change(function(e) {
       const file = e.target.files[0];
       if (!file) return;
       
       if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
           showSaveStatus('Seleziona un file JSON valido', 'error');
           return;
       }
       
       const reader = new FileReader();
       reader.onload = function(e) {
           try {
               const data = JSON.parse(e.target.result);
               loadDataFromObject(data);
               showSaveStatus(`File ${file.name} caricato con successo!`, 'success');
           } catch (error) {
               showSaveStatus('Errore durante il caricamento del file: ' + error.message, 'error');
           }
       };
       reader.readAsText(file);
       
       $(this).val('');
   });

   function loadDataFromObject(data) {
       // Ripristina dati base
       $('#tipo-agrume').val(data.tipoAgrume || '');
       $('#data-lavorazione').val(data.dataLavorazione || '');
       $('#selected-agrume').text(data.tipoAgrume || 'N/D');
       
       // Ripristina dati summary se presenti
       if (data.summaryData) {
           if (data.summaryData.succoseconda) {
               $('.destinazione-totale-seconda').val(data.summaryData.succoseconda.destinazione || 'NAT IN TINI');
               $('.tenore-polpa-seconda').val(data.summaryData.succoseconda.polpa || '<1%');
               $('.brix-seconda').val(data.summaryData.succoseconda.brix || 'NAT');
               $('.note-seconda').val(data.summaryData.succoseconda.note || 'SERB. ESTERNI');
           }
           if (data.summaryData.torchiato) {
               $('.destinazione-totale-torchiato').val(data.summaryData.torchiato.destinazione || 'CONCENTRATO');
               $('.tenore-polpa-torchiato').val(data.summaryData.torchiato.polpa || '<1%');
               $('.brix-torchiato').val(data.summaryData.torchiato.brix || '45');
               $('.note-torchiato').val(data.summaryData.torchiato.note || '');
           }
       }
       
       // Ripristina dati globali
       transferData = data.transferData || {};
       transferredAmounts = data.transferredAmounts || {};
       provenienzaData = data.provenienzaData || {};
       combinationData = data.combinationData || { verde: { indexes: [], details: [], totalCombination: 0 }, azzurro: { indexes: [], details: [], totalCombination: 0 }, viola: { indexes: [], details: [], totalCombination: 0 } };
       fornitoriData = data.fornitoriData || {};
       destinazioniData = data.destinazioniData || {};
       
       // Pulisci container pagine
       $('#pages-container').empty();
       initializePagesContainer();
       
       // Ripristina cards nell'ordine corretto
       if (data.cards && data.cards.length > 0) {
           // Ordina per cardIndex
           data.cards.sort((a, b) => a.cardIndex - b.cardIndex);
           
           data.cards.forEach((cardData) => {
               const cardIndex = cardData.cardIndex;
               const position = getNextAvailablePosition();
               
               if (cardData.cardType === 'supplier') {
                   const supplierNumber = cardData.supplierNumber || cardIndex;
                   const newCard = createSupplierCard(cardIndex, supplierNumber);
                   
                   // Aggiungi alla pagina corretta
                   const currentPage = $(`.main-grid[data-page="${position.pageIndex + 1}"]`);
                   if (currentPage.length === 0) {
                       createNewPage();
                   }
                   $(`.main-grid[data-page="${position.pageIndex + 1}"]`).append(newCard);
                   
                   const card = $(`.supplier-card[data-card-index="${cardIndex}"]`);
                   card.addClass(`card-position-${position.position}`);
                   
                   // Ripristina tutti i dati del fornitore
                   card.find('.nome-fornitore').val(cardData.nome || '');
                   card.find('.altro-fornitore').val(cardData.altroNome || '');
                   card.find('.quantita-entrata').val(cardData.quantitaEntrata || '');
                   card.find('.quantita-trasformata').val(cardData.quantitaTrasformata || '');
                   card.find('.giacenza').val(cardData.giacenza || '');
                   card.find('.certificazione').val(cardData.certificazione || '');
                   card.find('.altra-certificazione').val(cardData.altraCertificazione || '');
                   card.find('.varieta').val(cardData.varieta || '');
                   card.find('.altra-varieta').val(cardData.altraVarieta || '');
                   card.find('.linea').val(cardData.linea || '');
                   card.find('.portata').val(cardData.portata || '');
                   card.find('.orario-inizio').val(cardData.orarioInizio || '');
                   card.find('.orario-fine').val(cardData.orarioFine || '');
                   card.find('.succo-prima').val(cardData.succo || '');
                   card.find('.destinazione-prima').val(cardData.destinazione || '');
                   card.find('.altra-destinazione').val(cardData.altraDestinazione || '');
                   
                   // Ripristina caratteristiche
                   if (cardData.caratteristiche) {
                       const car = cardData.caratteristiche;
                       card.find('.tenore-polpa-prima').val(car.tenorePolpa || 'STANDARD');
                       card.find('.brix-prima').val(car.brix || 'NAT');
                       card.find('.bio-prima').val(car.bio || 'SI');
                       card.find('.pastorizzato-prima').val(car.pastorizzato || 'SI');
                       card.find('.conservato-prima').val(car.conservato || 'NO');
                       card.find('.note-prima').val(car.note || '');
                   }
                   
                   // Gestisci campi altro
                   if (cardData.nome === 'ALTRO') {
                       card.find('.altro-fornitore').removeClass('hidden-field');
                   }
                   if (cardData.certificazione === 'ALTRO') {
                       card.find('.altra-certificazione').removeClass('hidden-field');
                   }
                   if (cardData.varieta === 'ALTRO') {
                       card.find('.altra-varieta').removeClass('hidden-field');
                   }
                   if (cardData.destinazione === 'ALTRO') {
                       card.find('.altra-destinazione').removeClass('hidden-field');
                   }
                   
                   // Ripristina combinazioni
                   if (cardData.hasCombination) {
                       card.find('.succo-prima').addClass('combination-result');
                       if (cardData.combinationType) {
                           card.find('.succo-prima').attr('data-combination-type', cardData.combinationType);
                       }
                   }
                   
                   if (cardData.combinationColor) {
                       card.addClass(`combination-${cardData.combinationColor}`);
                       card.find('.card-header').addClass(`combination-${cardData.combinationColor}`);
                   }
                   
                   if (cardData.combinationDetails) {
                       card.find('.combination-details').removeClass('hidden-field').html(cardData.combinationDetails);
                   }
                   
                   // Ripristina trasferimenti
                   if (cardData.hasReceivedTransfers) {
                       card.find('.succo-prima').addClass('received-transfer');
                   }
                   
                   updateSupplier(cardIndex);
                   
               } else if (cardData.cardType === 'destination') {
                   const newCard = createDestinationCard(cardIndex, cardData.selectedSupplier);
                   
                   // Aggiungi alla pagina corretta
                   const currentPage = $(`.main-grid[data-page="${position.pageIndex + 1}"]`);
                   if (currentPage.length === 0) {
                       createNewPage();
                   }
                   $(`.main-grid[data-page="${position.pageIndex + 1}"]`).append(newCard);
                   
                   const card = $(`.destination-card[data-card-index="${cardIndex}"]`);
                   card.addClass(`card-position-${position.position}`);
                   
                   // Imposta fornitore selezionato
                   if (cardData.selectedSupplier) {
                       card.data('selected-supplier', cardData.selectedSupplier);
                   }
                   
                   // Ripristina dati destinazione
                   card.find('.quantita-prima-dest').val(cardData.quantitaPrima || '');
                   card.find('.destinazione-succo').val(cardData.destinazione || '');
                   card.find('.altra-destinazione-text').val(cardData.altraDestinazioneText || '');
                   
                   if (cardData.caratteristiche) {
                       const car = cardData.caratteristiche;
                       card.find('.tenore-polpa').val(car.tenorePolpa || 'STANDARD');
                       card.find('.altro-tenore-text').val(car.altroTenoreText || '');
                       card.find('.brix').val(car.brix || 'NAT');
                       card.find('.altro-brix-text').val(car.altroBrixText || '');
                       card.find('.bio').val(car.bio || 'SI');
                       card.find('.pastorizzato').val(car.pastorizzato || 'SI');
                       card.find('.conservato').val(car.conservato || 'NO');
                       card.find('.note').val(car.note || '');
                   }
                   
                   // Gestisci campi altro
                   if (cardData.destinazione === 'ALTRO') {
                       card.find('.altra-destinazione-text').removeClass('hidden-field');
                   }
                   if (cardData.caratteristiche?.tenorePolpa === 'ALTRO') {
                       card.find('.altro-tenore-text').removeClass('hidden-field');
                   }
                   if (cardData.caratteristiche?.brix === 'ALTRO') {
                       card.find('.altro-brix-text').removeClass('hidden-field');
                   }
                   
                   // Ripristina provenienza
                   if (provenienzaData[cardIndex]) {
                       const provenienzaText = provenienzaData[cardIndex]
                           .map(p => `${p.fornitore}: ${p.quantita}kg`)
                           .join(', ');
                       $(`#provenienza-${cardIndex}`).text(`Provenienza: ${provenienzaText}`);
                   }
                   
                   updateDestBioStyles(cardIndex);
               }
           });
       }
       
       // Riorganizza con priorità dopo il caricamento
       reorganizeCardsWithPriority();
       
       // Aggiorna tutto
       updateTotals();
       updateElementsCount();
       updateCombinazioneOptions();
       toggleCombinazioniSection();
       updateTransferOptions();
       updateDestinationHeaders();
       updateSummaryCards();
       checkSummaryVisibility();
       
       // Aggiorna varietà
       const agrume = $('#tipo-agrume').val();
       if (agrume && varietyOptions[agrume]) {
           $('.varieta').each(function() {
               const current = $(this).val();
               $(this).empty().append('<option value="">Seleziona varietà</option>');
               varietyOptions[agrume].forEach(variety => {
                   $(this).append(`<option value="${variety}">${variety}</option>`);
               });
               $(this).val(current);
           });
       }
       
       showSaveStatus('Dati caricati con successo!', 'success');
   }

   function showSaveStatus(message, type) {
       const statusDiv = $('#save-status');
       const messageSpan = $('#save-message');
       
       messageSpan.text(message);
       
       if (type === 'error') {
           statusDiv.addClass('save-error').removeClass('save-status');
       } else {
           statusDiv.removeClass('save-error').addClass('save-status');
       }
       
       statusDiv.fadeIn();
       
       setTimeout(() => {
           statusDiv.fadeOut();
       }, 3000);
   }

   // Eventi principali
   $('#tipo-agrume').change(function() {
       const agrume = $(this).val();
       $('#selected-agrume').text(agrume || 'N/D');
       
       // Aggiorna varietà in tutte le card esistenti
       if (agrume && varietyOptions[agrume]) {
           $('.varieta').each(function() {
               const current = $(this).val();
               $(this).empty().append('<option value="">Seleziona varietà</option>');
               varietyOptions[agrume].forEach(variety => {
                   $(this).append(`<option value="${variety}">${variety}</option>`);
               });
               $(this).val(current);
           });
       }
       
       // Ricalcola tutti i fornitori
       $('.supplier-card').each(function() {
           const cardIndex = $(this).data('card-index');
           calculateSupplier(cardIndex);
           updateDestinationCard(cardIndex);
       });
       
       updateTotals();
       updateSummaryCards();
       checkSummaryVisibility();
   });

   $('#aggiungi-fornitore').click(function() {
       if (!$('#tipo-agrume').val()) {
           alert('Seleziona prima il tipo di agrume');
           return;
       }
       
       const position = getNextAvailablePosition();
       const cardIndex = getNextCardIndex();
       const supplierNumber = getNextSupplierNumber();
       const newCard = createSupplierCard(cardIndex, supplierNumber);
       
       // Aggiungi alla pagina corretta
       const currentPage = $(`.main-grid[data-page="${position.pageIndex + 1}"]`);
       if (currentPage.length === 0) {
           createNewPage();
       }
       $(`.main-grid[data-page="${position.pageIndex + 1}"]`).append(newCard);
       
       // Aggiungi la classe di posizione
       $(`.supplier-card[data-card-index="${cardIndex}"]`).addClass(`card-position-${position.position}`);
       
       updateElementsCount();
       updateCombinazioneOptions();
       toggleCombinazioniSection();
       updateTransferOptions();
       updateDestinationHeaders();
       checkSummaryVisibility();
   });

   // Gestione aggiunta destinazione con selezione fornitore
   $('#aggiungi-destinazione').click(async function() {
       try {
           const position = getNextAvailablePosition();
           
           // Mostra modal per selezione fornitore
           const selectedSupplier = await showSupplierSelectionModal();
           
           const cardIndex = getNextCardIndex();
           const newCard = createDestinationCard(cardIndex, selectedSupplier);
           
           // Aggiungi alla pagina corretta
           const currentPage = $(`.main-grid[data-page="${position.pageIndex + 1}"]`);
           if (currentPage.length === 0) {
               createNewPage();
           }
           $(`.main-grid[data-page="${position.pageIndex + 1}"]`).append(newCard);
           
           // Aggiungi la classe di posizione
           const card = $(`.destination-card[data-card-index="${cardIndex}"]`);
           card.addClass(`card-position-${position.position}`);
           card.data('selected-supplier', selectedSupplier);
           
           updateElementsCount();
           updateTransferOptions();
           updateDestinationHeaders();
           
       } catch (error) {
           if (error !== 'Operazione annullata') {
               alert(error);
           }
       }
   });

   // Eventi combinazioni
   $('#applica-combinazione-verde').click(function() {
       applyCombination('verde');
   });

   $('#reset-combinazione-verde').click(function() {
       resetCombination('verde');
   });

   $('#applica-combinazione-azzurro').click(function() {
       applyCombination('azzurro');
   });

   $('#reset-combinazione-azzurro').click(function() {
       resetCombination('azzurro');
   });

   $('#applica-combinazione-viola').click(function() {
       applyCombination('viola');
   });

   $('#reset-combinazione-viola').click(function() {
       resetCombination('viola');
   });

   // Eventi salvataggio e caricamento
   $('#salva-file').click(function() {
       saveToFile();
   });

   $('#carica-file').click(function() {
       if (confirm('Attenzione: il caricamento del file sovrascriverà tutti i dati attuali. Continuare?')) {
           loadFromFile();
       }
   });

   $('#reset-tutto').click(function() {
       if (confirm('Attenzione: questa operazione cancellerà tutti i dati inseriti. Continuare?')) {
           location.reload();
       }
   });

   // Gestione eventi dinamici per campi "ALTRO"
   $(document).on('change', '.certificazione', function() {
       const card = $(this).closest('.supplier-card');
       const cardIndex = card.data('card-index');
       const cert = $(this).val();
       const altroField = card.find('.altra-certificazione');
       
       if (cert === 'ALTRO') {
           altroField.removeClass('hidden-field');
       } else {
           altroField.addClass('hidden-field').val('');
       }
       
       updateBioStyle(cardIndex);
   });

   // Altri eventi dinamici per destinazioni
   $(document).on('change', '.destinazione-succo', function() {
       const card = $(this).closest('.destination-card');
       const cardIndex = card.data('card-index');
       toggleAltroDestinazione(cardIndex);
       updateDestBioStyles(cardIndex);
   });

   $(document).on('change', '.tenore-polpa', function() {
       const card = $(this).closest('.destination-card');
       const cardIndex = card.data('card-index');
       toggleAltroTenore(cardIndex);
   });

   $(document).on('change', '.brix', function() {
       const card = $(this).closest('.destination-card');
       const cardIndex = card.data('card-index');
       toggleAltroBrix(cardIndex);
   });

   $(document).on('input', '.quantita-prima-dest', function() {
       const card = $(this).closest('.destination-card');
       const cardIndex = card.data('card-index');
       updateDestBioStyles(cardIndex);
   });

   $(document).on('change', '.bio', function() {
       const card = $(this).closest('.destination-card');
       const cardIndex = card.data('card-index');
       updateDestBioStyles(cardIndex);
   });

   // Funzioni di utilità
   $(document).on('focus', 'input[type="number"]', function() {
       $(this).select();
   });

   $(document).on('keypress', 'input', function(e) {
       if (e.which === 13) {
           $(this).blur();
           const nextInput = $(this).closest('.form-row').next().find('input, select').first();
           if (nextInput.length) {
               nextInput.focus();
           }
       }
   });

   // Auto-save ogni 30 secondi
   setInterval(function() {
       const hasData = $('.supplier-card, .destination-card').length > 0;
       if (hasData) {
           try {
               const data = collectProgramData();
               localStorage.setItem('autoSaveData', JSON.stringify(data));
               console.log('Auto-save completato');
           } catch (error) {
               console.log('Errore auto-save:', error);
           }
       }
   }, 30000);

   // Ripristino auto-save all'avvio
   function checkAutoSave() {
       const autoSaveData = localStorage.getItem('autoSaveData');
       if (autoSaveData) {
           if (confirm('Trovati dati salvati automaticamente. Vuoi ripristinarli?')) {
               try {
                   const data = JSON.parse(autoSaveData);
                   loadDataFromObject(data);
                   showSaveStatus('Dati auto-salvati ripristinati', 'success');
               } catch (error) {
                   console.log('Errore ripristino auto-save:', error);
                   localStorage.removeItem('autoSaveData');
               }
           } else {
               localStorage.removeItem('autoSaveData');
           }
       }
   }

   // Gestione chiusura pagina
   window.addEventListener('beforeunload', function(e) {
       const hasUnsavedData = $('.supplier-card, .destination-card').length > 0;
       if (hasUnsavedData) {
           e.preventDefault();
           e.returnValue = 'Ci sono dati non salvati. Vuoi davvero uscire?';
       }
   });

   // Gestione tasti scorciatoia
   $(document).keydown(function(e) {
       if (e.ctrlKey) {
           switch(e.which) {
               case 83: // Ctrl+S - Salva
                   e.preventDefault();
                   saveToFile();
                   break;
               case 79: // Ctrl+O - Apri
                   e.preventDefault();
                   $('#carica-file').click();
                   break;
               case 80: // Ctrl+P - Stampa
                   e.preventDefault();
                   window.print();
                   break;
               case 78: // Ctrl+N - Nuovo fornitore
                   e.preventDefault();
                   $('#aggiungi-fornitore').click();
                   break;
               case 77: // Ctrl+M - Nuova destinazione
                   e.preventDefault();
                   $('#aggiungi-destinazione').click();
                   break;
           }
       }
   });

   // Controllo validità dati
   function validateData() {
       let isValid = true;
       let errors = [];
       
       $('.supplier-card').each(function() {
           const cardIndex = $(this).data('card-index');
           const supplierNumber = $(this).data('supplier-number');
           const nome = $(this).find('.nome-fornitore').val();
           const entrata = parseFloat($(this).find('.quantita-entrata').val()) || 0;
           const trasformata = parseFloat($(this).find('.quantita-trasformata').val()) || 0;
           
           if (!nome) {
               errors.push(`F${supplierNumber}: Nome fornitore mancante`);
               isValid = false;
           }
           
           if (trasformata > entrata) {
               errors.push(`F${supplierNumber}: Quantità trasformata superiore all'entrata`);
               isValid = false;
           }
       });
       
       if (!$('#tipo-agrume').val()) {
           errors.push('Tipo di agrume non selezionato');
           isValid = false;
       }
       
       if (!$('#data-lavorazione').val()) {
           errors.push('Data di lavorazione non inserita');
           isValid = false;
       }
       
       if (!isValid) {
           alert('Errori di validazione:\n' + errors.join('\n'));
       }
       
       return isValid;
   }

   // Override del salvataggio con validazione
   const originalSaveToFile = saveToFile;
   saveToFile = function() {
       if (validateData()) {
           originalSaveToFile();
       }
   };

   // Controllo responsive per mobile
   function checkMobileView() {
       if (window.innerWidth < 768) {
           $('.main-grid').css('grid-template-columns', 'repeat(2, 1fr)');
           alert('Per una migliore esperienza su dispositivi mobili, si consiglia di ruotare il dispositivo in modalità landscape.');
       }
   }

   // Inizializzazione completa
   initApp();
   checkAutoSave();
   checkMobileView();

   // Event listener per il ridimensionamento finestra
   $(window).resize(function() {
       checkMobileView();
   });

   console.log('Sistema Programma Giornaliero Trasformazione inizializzato - VERSIONE LAYOUT TABELLARE');
   console.log('Modifiche implementate:');
   console.log('- Eliminati pulsanti Succo 2ª e Torchiato');
   console.log('- Card Succo 2ª e Torchiato visualizzate in sezione dedicata 2x1');
   console.log('- Layout stampa tabellare con intestazioni personalizzate');
   console.log('- Mantenimento criteri colorazione BIO (rosso/nero)');
   console.log('- Applicazione logica colori combinazioni anche in stampa');
   console.log('- Condizione BOE/1100 mantenuta per Succo 2ª');
   console.log('Tasti scorciatoia: Ctrl+S (Salva), Ctrl+O (Apri), Ctrl+P (Stampa), Ctrl+N (Nuovo Fornitore), Ctrl+M (Nuova Destinazione)');
});
</script>
</body>
</html>
