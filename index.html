<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Programma Giornaliero Trasformazione Frutta - Layout Tabellare</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<style>
* {
   margin: 0;
   padding: 0;
   box-sizing: border-box;
}

body { 
   font-family: 'Arial', sans-serif;
   font-size: 18px;
   line-height: 1.4;
   color: #000000;
   margin: 20px;
   background-color: #f5f5f5;
}

.header {
   text-align: center;
   margin-bottom: 20px;
   background: #1e3c72;
   border: 2px solid #000000;
   padding: 15px;
   border-radius: 10px;
   color: #ffffff;
}

.header h1 {
   font-size: 28px;
   margin-bottom: 8px;
   font-weight: bold;
   color: #ffffff;
}

.header .subtitle {
   font-size: 22px;
   margin-bottom: 8px;
   color: #ffffff;
}

.header-info {
   display: flex;
   justify-content: space-around;
   margin-top: 12px;
   font-size: 18px;
   color: #ffffff;
}

.controls-section {
   background-color: #e9ecef;
   border: 1px solid #000000;
   border-radius: 8px;
   padding: 15px;
   margin-bottom: 20px;
   display: flex;
   gap: 20px;
   align-items: center;
   flex-wrap: wrap;
}

.controls-section .form-group {
   display: flex;
   flex-direction: column;
   min-width: 200px;
}

.controls-section label {
   font-weight: bold;
   margin-bottom: 5px;
   color: #000000;
   font-size: 16px;
}

.controls-section .form-control,
.controls-section .form-select {
   border: 1px solid #000000;
   border-radius: 5px;
   padding: 8px;
   font-size: 16px;
}

.btn {
   padding: 10px 18px;
   border: none;
   border-radius: 6px;
   font-weight: bold;
   cursor: pointer;
   text-decoration: none;
   display: inline-block;
   margin: 4px;
   font-size: 14px;
}

.btn-primary {
   background: #1e3c72;
   color: white;
}

.btn-success {
   background: #28a745;
   color: white;
}

.btn-warning {
   background: #ffc107;
   color: #000000;
}

.btn-danger {
   background: #dc3545;
   color: white;
}

.btn-info {
   background: #17a2b8;
   color: white;
}

.totals-section {
   display: flex;
   justify-content: space-around;
   margin-bottom: 20px;
   background-color: #ffc107;
   padding: 15px;
   border: 1px solid #000000;
   border-radius: 8px;
}

.total-item {
   text-align: center;
   color: #000000;
}

.total-value {
   font-size: 26px;
   font-weight: bold;
   color: #000000;
}

.total-label {
   font-size: 16px;
   margin-top: 4px;
   color: #000000;
}

/* LAYOUT PRINCIPALE - 4 COLONNE x 2 RIGHE PER PAGINA */
.main-grid {
   display: grid;
   grid-template-columns: repeat(4, 1fr);
   grid-template-rows: auto auto;
   gap: 15px;
   margin-bottom: 20px;
   min-height: 75vh;
   page-break-after: always;
}

/* POSIZIONI SPECIFICHE PER LE 8 CARD PER PAGINA */
.card-position-1 { grid-column: 1; grid-row: 1; }
.card-position-2 { grid-column: 1; grid-row: 2; }
.card-position-3 { grid-column: 2; grid-row: 1; }
.card-position-4 { grid-column: 2; grid-row: 2; }
.card-position-5 { grid-column: 3; grid-row: 1; }
.card-position-6 { grid-column: 3; grid-row: 2; }
.card-position-7 { grid-column: 4; grid-row: 1; }
.card-position-8 { grid-column: 4; grid-row: 2; }

.supplier-card {
   background-color: #e9ecef;
   border: 2px solid #000000;
   border-radius: 10px;
   padding: 12px;
   min-height: 480px;
   max-height: 480px;
   overflow-y: auto;
}

.destination-card {
   background-color: #f0f8ff;
   border: 2px solid #007bff;
   border-radius: 10px;
   padding: 12px;
   min-height: 380px;
   max-height: 380px;
   overflow-y: auto;
}

/* COMBINAZIONI COLORI */
.supplier-card.combination-verde {
   background-color: #d4edda;
   border: 2px solid #28a745;
}

.supplier-card.combination-azzurro {
   background-color: #d1ecf1;
   border: 2px solid #17a2b8;
}

.supplier-card.combination-viola {
   background-color: #e2e3f3;
   border: 2px solid #6f42c1;
}

.card-header {
   background: #6c757d;
   color: #ffffff;
   padding: 8px;
   text-align: center;
   font-weight: bold;
   font-size: 18px;
   margin: -12px -12px 12px -12px;
   border-radius: 8px 8px 0 0;
}

.card-header.combination-verde {
   background: #28a745;
}

.card-header.combination-azzurro {
   background: #17a2b8;
}

.card-header.combination-viola {
   background: #6f42c1;
}

.dest-card-header {
   background: #007bff;
   color: #ffffff;
   padding: 8px;
   text-align: center;
   font-weight: bold;
   font-size: 18px;
   margin: -12px -12px 12px -12px;
   border-radius: 8px 8px 0 0;
}

.form-row {
   display: flex;
   justify-content: space-between;
   margin-bottom: 8px;
   align-items: center;
}

.form-label {
   font-weight: bold;
   color: #000000;
   width: 40%;
   font-size: 14px;
}

.form-input {
   width: 58%;
}

.form-input input,
.form-input select,
.form-input textarea {
   width: 100%;
   border: 1px solid #000000;
   border-radius: 5px;
   padding: 4px;
   font-size: 13px;
}

.form-input textarea {
   min-height: 45px;
   resize: vertical;
}

.calculated-field {
   background-color: #e7f3ff;
   font-weight: bold;
   text-align: center;
}

.yield-result {
   background-color: #e8f5e8;
   font-weight: bold;
   text-align: center;
}

.bio-red-field {
   color: #dc3545 !important;
   font-weight: bold;
   border-color: #dc3545 !important;
}

.bio-black-field {
   color: #000000 !important;
   font-weight: bold;
   border-color: #495057 !important;
}

.bio-red-text {
   color: #dc3545 !important;
   font-weight: bold;
}

.bio-black-text {
   color: #000000 !important;
   font-weight: bold;
}

.combination-result {
   background-color: #fff3cd !important;
   border: 2px solid #ffc107 !important;
   font-weight: bold;
   color: #856404 !important;
}

.received-transfer {
   background-color: #d4edda !important;
   border: 2px solid #28a745 !important;
}

.section-divider {
   border-bottom: 1px solid #6c757d;
   margin: 8px 0;
}

.remaining-qty {
   background-color: #e7f3ff;
   border: 1px solid #2a5298;
   padding: 5px;
   border-radius: 4px;
   font-weight: bold;
   text-align: center;
   color: #1e3c72;
   font-size: 12px;
   margin: 8px 0;
}

.transfer-section {
   background-color: #fff3cd;
   border: 1px solid #ffc107;
   border-radius: 4px;
   padding: 8px;
   margin-top: 8px;
}

.transfer-row {
   display: flex;
   align-items: center;
   gap: 5px;
   flex-wrap: wrap;
}

.transfer-row select {
   flex: 1;
   min-width: 70px;
   font-size: 11px;
   padding: 3px;
}

.transfer-row input {
   width: 45px;
   font-size: 11px;
   padding: 3px;
}

.transfer-row .btn {
   padding: 3px 8px;
   font-size: 10px;
   margin: 0;
}

.card-buttons {
   margin-top: 10px;
   text-align: center;
}

.card-buttons .btn {
   padding: 4px 10px;
   font-size: 11px;
   margin: 3px;
}

.hidden-field {
   display: none;
}

.combination-details {
   font-size: 11px;
   color: #856404;
   margin-top: 4px;
   background-color: #fff3cd;
   padding: 5px;
   border-radius: 4px;
   border: 1px solid #ffc107;
   line-height: 1.3;
}

.transfer-details {
   font-size: 11px;
   color: #000000;
   margin-top: 4px;
   background-color: #d4edda;
   padding: 4px;
   border-radius: 4px;
   border: 1px solid #28a745;
}

.provenienza-info {
   background-color: #e8f5e8;
   border: 1px solid #28a745;
   padding: 5px;
   border-radius: 4px;
   font-size: 11px;
   color: #155724;
   margin-bottom: 8px;
}

.save-status {
   background-color: #d4edda;
   border: 1px solid #28a745;
   color: #155724;
   padding: 10px;
   border-radius: 5px;
   margin-bottom: 15px;
   text-align: center;
   display: none;
}

.save-error {
   background-color: #f8d7da;
   border: 1px solid #dc3545;
   color: #721c24;
}

/* SEZIONI COMBINAZIONI */
.combination-section {
   background-color: #f8f9fa;
   border: 1px solid #000000;
   border-radius: 8px;
   padding: 15px;
   margin-bottom: 20px;
}

.combination-group {
   background-color: #f0f8ff;
   border: 2px solid #007bff;
   border-radius: 10px;
   padding: 15px;
   margin-bottom: 15px;
}

.combination-group-b {
   background-color: #f0fff0;
   border: 2px solid #28a745;
   border-radius: 10px;
   padding: 15px;
   margin-bottom: 15px;
}

.combination-group-c {
   background-color: #f3f0ff;
   border: 2px solid #6f42c1;
   border-radius: 10px;
   padding: 15px;
   margin-bottom: 15px;
}

/* MODAL SELEZIONE FORNITORE */
.modal-backdrop {
   position: fixed;
   top: 0;
   left: 0;
   width: 100%;
   height: 100%;
   background-color: rgba(0,0,0,0.5);
   display: none;
   z-index: 1000;
}

.modal-content {
   position: fixed;
   top: 50%;
   left: 50%;
   transform: translate(-50%, -50%);
   background-color: white;
   padding: 20px;
   border-radius: 8px;
   border: 2px solid #000;
   min-width: 300px;
   z-index: 1001;
}

.modal-header {
   margin-bottom: 15px;
   text-align: center;
   font-weight: bold;
   font-size: 18px;
}

.modal-body {
   margin-bottom: 15px;
}

.modal-footer {
   text-align: center;
}

/* CARD SUCCO 2ª E TORCHIATO NELLA PARTE BASSA */
.summary-footer {
   display: flex;
   gap: 20px;
   margin-top: 30px;
   justify-content: space-between;
   page-break-inside: avoid;
}

.summary-card-footer,
.torchiato-card-footer {
   flex: 1;
   background-color: #f8f9fa;
   border: 2px solid #000000;
   border-radius: 10px;
   padding: 15px;
   min-height: 200px;
}

.summary-card-footer .card-header {
   background: #ffc107;
   color: #000000;
   margin: -15px -15px 15px -15px;
}

.torchiato-card-footer .card-header {
   background: #dc3545;
   color: #ffffff;
   margin: -15px -15px 15px -15px;
}

/* STILI STAMPA TABELLARI */
@media print {
   body { 
       margin: 5mm !important;
       background-color: white !important;
       font-size: 10px !important;
   }
   
   .controls-section,
   .combination-section,
   .main-grid,
   .summary-footer {
       display: none !important;
   }
   
   .btn {
       display: none !important;
   }
   
   .header {
       background: #1e3c72 !important;
       color: #ffffff !important;
       border: 2px solid #000000 !important;
       margin-bottom: 10px !important;
       page-break-after: avoid !important;
   }
   
   .print-table {
       display: table !important;
       width: 100% !important;
       border-collapse: collapse !important;
       margin-top: 10px !important;
   }
   
   .print-table-header {
       display: table-header-group !important;
       background-color: #e9ecef !important;
       font-weight: bold !important;
       border: 1px solid #000000 !important;
   }
   
   .print-table-header-row {
       display: table-row !important;
   }
   
   .print-table-header-cell {
       display: table-cell !important;
       padding: 4px 2px !important;
       text-align: center !important;
       border: 1px solid #000000 !important;
       font-size: 8px !important;
       font-weight: bold !important;
       vertical-align: middle !important;
   }
   
   .print-table-body {
       display: table-row-group !important;
   }
   
   .print-table-row {
       display: table-row !important;
       page-break-inside: avoid !important;
   }
   
   .print-table-row.combination-verde {
       background-color: #d4edda !important;
   }
   
   .print-table-row.combination-azzurro {
       background-color: #d1ecf1 !important;
   }
   
   .print-table-row.combination-viola {
       background-color: #e2e3f3 !important;
   }
   
   .print-table-cell {
       display: table-cell !important;
       padding: 3px 2px !important;
       text-align: center !important;
       border: 1px solid #000000 !important;
       font-size: 8px !important;
       vertical-align: middle !important;
       word-wrap: break-word !important;
       max-width: 50px !important;
   }
   
   .print-table-cell.bio-red-text {
       color: #dc3545 !important;
       font-weight: bold !important;
   }
   
   .print-table-cell.bio-black-text {
       color: #000000 !important;
       font-weight: bold !important;
   }
   
   .print-summary-footer {
       display: flex !important;
       gap: 10px !important;
       margin-top: 15px !important;
       page-break-inside: avoid !important;
   }
   
   .print-summary-card,
   .print-torchiato-card {
       flex: 1 !important;
       border: 2px solid #000000 !important;
       padding: 8px !important;
       background-color: #f8f9fa !important;
   }
   
   .print-summary-card .card-header {
       background: #ffc107 !important;
       color: #000000 !important;
       padding: 5px !important;
       text-align: center !important;
       font-weight: bold !important;
       margin: -8px -8px 8px -8px !important;
   }
   
   .print-torchiato-card .card-header {
       background: #dc3545 !important;
       color: #ffffff !important;
       padding: 5px !important;
       text-align: center !important;
       font-weight: bold !important;
       margin: -8px -8px 8px -8px !important;
   }
   
   .print-summary-row {
       display: flex !important;
       justify-content: space-between !important;
       margin: 3px 0 !important;
       font-size: 9px !important;
   }
   
   .print-summary-label {
       font-weight: bold !important;
   }
   
   .totals-section {
       background-color: #ffc107 !important;
       color: #000000 !important;
       border: 1px solid #000000 !important;
   }
   
   .total-value,
   .total-label {
       color: #000000 !important;
   }
   
   @page {
       margin: 8mm;
       size: A4 landscape;
   }
}

/* PAGINAZIONE AUTOMATICA */
.page-break {
   page-break-before: always;
}
</style>
</head>

<body>
   <div class="header">
       <h1>PROGRAMMA GIORNALIERO TRASFORMAZIONE FRUTTA</h1>
       <div class="subtitle">Sistema di Gestione Produzione - Simone Gatto</div>
       <div class="header-info">
           <div><strong>Data:</strong> <span id="current-date"></span></div>
           <div><strong>Agrume:</strong> <span id="selected-agrume">N/D</span></div>
           <div><strong>Elementi:</strong> <span id="elements-count">0</span></div>
           <div><strong>Pagine:</strong> <span id="pages-count">0</span></div>
       </div>
       <div style="margin-top: 8px; font-size: 16px;">
           <strong>Generato:</strong> <span id="last-revision"></span>
       </div>
   </div>

   <!-- Status salvataggio -->
   <div id="save-status" class="save-status">
       <span id="save-message"></span>
   </div>

   <!-- Sezione Controlli -->
   <div class="controls-section">
       <div class="form-group">
           <label for="tipo-agrume">Tipo di Agrume</label>
           <select class="form-select" id="tipo-agrume">
               <option value="">Seleziona agrume</option>
               <option value="LIMONE">Limone</option>
               <option value="ARANCIA">Arancia</option>
               <option value="MANDARINO">Mandarino</option>
               <option value="POMPELMO">Pompelmo</option>
               <option value="BERGAMOTTO">Bergamotto</option>
           </select>
       </div>
       
       <div class="form-group">
           <label for="data-lavorazione">Data Lavorazione</label>
           <input type="date" class="form-control" id="data-lavorazione">
       </div>
       
       <div>
           <button type="button" class="btn btn-primary" id="aggiungi-fornitore">
               <i class="bi bi-plus-circle"></i> Aggiungi Fornitore
           </button>
           <button type="button" class="btn btn-success" id="aggiungi-destinazione">
               <i class="bi bi-plus-square"></i> Aggiungi Destinazione
           </button>
           <button type="button" class="btn btn-info" id="salva-file">
               <i class="bi bi-download"></i> Salva File
           </button>
           <button type="button" class="btn btn-info" id="carica-file">
               <i class="bi bi-upload"></i> Carica File
           </button>
           <button type="button" class="btn btn-warning" onclick="window.print()">
               <i class="bi bi-printer"></i> Stampa
           </button>
           <button type="button" class="btn btn-danger" id="reset-tutto">
               <i class="bi bi-arrow-clockwise"></i> Reset
           </button>
       </div>
   </div>

   <!-- Sezione Totali -->
   <div class="totals-section">
       <div class="total-item">
           <div class="total-value" id="entrata-totale">0</div>
           <div class="total-label">Kg Entrata</div>
       </div>
       <div class="total-item">
           <div class="total-value" id="trasformata-totale">0</div>
           <div class="total-label">Kg Trasformati</div>
       </div>
       <div class="total-item">
           <div class="total-value" id="giacenza-totale">0</div>
           <div class="total-label">Kg Giacenza</div>
       </div>
   </div>

   <!-- Sezione Combinazioni -->
   <div id="combinazioni-section" class="combination-section hidden-field">
       <h3 style="margin-bottom: 15px; color: #1e3c72;"><i class="bi bi-diagram-3"></i> Selezione Combinazioni Fornitori</h3>
       
       <div class="combination-group">
           <h5><i class="bi bi-diagram-2"></i> Combinazione Verde - Succo 1ª</h5>
           <div style="margin-bottom: 10px;">
               <select class="form-select" id="combinazione-fornitori-verde" style="width: 100%; margin-bottom: 10px;">
                   <option value="">Seleziona combinazione Verde</option>
               </select>
               <button type="button" class="btn btn-success" id="applica-combinazione-verde">
                   <i class="bi bi-check-circle"></i> Applica Verde
               </button>
               <button type="button" class="btn btn-warning" id="reset-combinazione-verde">
                   <i class="bi bi-x-circle"></i> Reset Verde
               </button>
           </div>
       </div>
       
       <div class="combination-group-b">
           <h5><i class="bi bi-diagram-3"></i> Combinazione Azzurro - Succo 1ª</h5>
           <div style="margin-bottom: 10px;">
               <select class="form-select" id="combinazione-fornitori-azzurro" style="width: 100%; margin-bottom: 10px;">
                   <option value="">Seleziona combinazione Azzurro</option>
               </select>
               <button type="button" class="btn btn-info" id="applica-combinazione-azzurro">
                   <i class="bi bi-check-circle"></i> Applica Azzurro
               </button>
               <button type="button" class="btn btn-warning" id="reset-combinazione-azzurro">
                   <i class="bi bi-x-circle"></i> Reset Azzurro
               </button>
           </div>
       </div>

       <div class="combination-group-c">
           <h5><i class="bi bi-diagram-3"></i> Combinazione Viola - Succo 1ª</h5>
           <div>
               <select class="form-select" id="combinazione-fornitori-viola" style="width: 100%; margin-bottom: 10px;">
                   <option value="">Seleziona combinazione Viola</option>
               </select>
               <button type="button" class="btn" style="background: #6f42c1; color: white;" id="applica-combinazione-viola">
                   <i class="bi bi-check-circle"></i> Applica Viola
               </button>
               <button type="button" class="btn btn-warning" id="reset-combinazione-viola">
                   <i class="bi bi-x-circle"></i> Reset Viola
               </button>
           </div>
       </div>
   </div>

   <!-- CONTAINER PRINCIPALE PER LE PAGINE -->
   <div id="pages-container">
       <!-- Le pagine verranno generate dinamicamente qui -->
   </div>

   <!-- Sezione Succo 2ª e Torchiato nella parte bassa -->
   <div class="summary-footer">
       <div class="summary-card-footer">
           <div class="card-header">TOTALE SUCCO 2ª</div>
           
           <div class="form-row">
               <span class="form-label">Quantità Totale (kg):</span>
               <div class="form-input">
                   <input type="number" class="totale-succo-seconda calculated-field" readonly>
               </div>
           </div>

           <div class="form-row">
               <span class="form-label">Destinazione:</span>
               <div class="form-input">
                   <select class="destinazione-totale-seconda">
                       <option value="NAT IN TINI" selected>NAT IN TINI</option>
                       <option value="CONCENTRATO">CONCENTRATO</option>
                       <option value="ALTRO">ALTRO</option>
                   </select>
                   <input type="text" class="altra-dest-seconda hidden-field" placeholder="Altra destinazione" style="margin-top: 3px; font-size: 11px;">
               </div>
           </div>

           <div class="form-row">
               <span class="form-label">Polpa:</span>
               <div class="form-input">
                   <select class="tenore-polpa-seconda">
                       <option value="<1%" selected><1%</option>
                       <option value="STANDARD">STANDARD</option>
                       <option value="LIMPIDO">LIMPIDO</option>
                       <option value="2%">2%</option>
                       <option value="3%">3%</option>
                       <option value="6%">6%</option>
                       <option value="ALTRO">ALTRO</option>
                   </select>
               </div>
           </div>

           <div class="form-row">
               <span class="form-label">°BX:</span>
               <div class="form-input">
                   <select class="brix-seconda">
                       <option value="NAT" selected>NAT</option>
                       <option value="20">20</option>
                       <option value="32">32</option>
                       <option value="40">40</option>
                       <option value="45">45</option>
                       <option value="ALTRO">ALTRO</option>
                   </select>
               </div>
           </div>

           <div class="form-row">
               <span class="form-label">Pastorizzato:</span>
               <div class="form-input">
                   <select class="pastorizzato-seconda">
                       <option value="SI" selected>SI</option>
                       <option value="NO">NO</option>
                   </select>
               </div>
           </div>

           <div class="form-row">
               <span class="form-label">Conservato:</span>
               <div class="form-input">
                   <select class="conservato-seconda">
                       <option value="SI" selected>SI</option>
                       <option value="NO">NO</option>
                   </select>
               </div>
           </div>

           <div class="form-row">
               <span class="form-label">Note:</span>
               <div class="form-input">
                   <textarea class="note-seconda" placeholder="Note succo 2ª" rows="2">SERB. ESTERNI</textarea>
               </div>
           </div>
       </div>

       <div class="torchiato-card-footer">
           <div class="card-header">TOTALE TORCHIATO</div>
           
           <div class="form-row">
               <span class="form-label">Quantità Totale (kg):</span>
               <div class="form-input">
                   <input type="number" class="totale-torchiato calculated-field" readonly>
               </div>
           </div>

           <div class="form-row">
               <span class="form-label">Destinazione:</span>
               <div class="form-input">
                   <select class="destinazione-totale-torchiato">
                       <option value="CONCENTRATO" selected>CONCENTRATO</option>
                       <option value="NAT IN TINI">NAT IN TINI</option>
                       <option value="F.F.">F.F.</option>
                       <option value="F.T.C">F.T.C</option>
                       <option value="FBL">FBL</option>
                       <option value="BIC">BIC</option>
                       <option value="ALTRO">ALTRO</option>
                   </select>
               </div>
           </div>

           <div class="form-row">
               <span class="form-label">Polpa:</span>
               <div class="form-input">
                   <select class="tenore-polpa-torchiato">
                       <option value="<1%" selected><1%</option>
                       <option value="STANDARD">STANDARD</option>
                       <option value="LIMPIDO">LIMPIDO</option>
                       <option value="2%">2%</option>
                       <option value="3%">3%</option>
                       <option value="6%">6%</option>
                       <option value="ALTRO">ALTRO</option>
                   </select>
               </div>
           </div>

           <div class="form-row">
               <span class="form-label">°BX:</span>
               <div class="form-input">
                   <select class="brix-torchiato">
                       <option value="45" selected>45</option>
                       <option value="NAT">NAT</option>
                       <option value="20">20</option>
                       <option value="32">32</option>
                       <option value="40">40</option>
                       <option value="50">50</option>
                       <option value="55">55</option>
                       <option value="60">60</option>
                       <option value="65">65</option>
                       <option value="ALTRO">ALTRO</option>
                   </select>
               </div>
           </div>

           <div class="form-row">
               <span class="form-label">Pastorizzato:</span>
               <div class="form-input">
                   <select class="pastorizzato-torchiato">
                       <option value="SI" selected>SI</option>
                       <option value="NO">NO</option>
                   </select>
               </div>
           </div>

           <div class="form-row">
               <span class="form-label">Conservato:</span>
               <div class="form-input">
                   <select class="conservato-torchiato">
                       <option value="NO" selected>NO</option>
                       <option value="SI">SI</option>
                   </select>
               </div>
           </div>

           <div class="form-row">
               <span class="form-label">Note:</span>
               <div class="form-input">
                   <textarea class="note-torchiato" placeholder="Note torchiato" rows="2"></textarea>
               </div>
           </div>
       </div>
   </div>

   <!-- TABELLA PER LA STAMPA (nascosta normalmente) -->
   <div class="print-table" style="display: none;">
       <div class="print-table-header">
           <div class="print-table-header-row">
               <div class="print-table-header-cell">LINEA TRASF.</div>
               <div class="print-table-header-cell">NOME FORN.</div>
               <div class="print-table-header-cell">ENTRATA</div>
               <div class="print-table-header-cell">TRASFORMATA</div>
               <div class="print-table-header-cell">GIACENZA</div>
               <div class="print-table-header-cell">CERT.</div>
               <div class="print-table-header-cell">VARIETÀ</div>
               <div class="print-table-header-cell">PORTATA</div>
               <div class="print-table-header-cell">INIZIO</div>
               <div class="print-table-header-cell">FINE</div>
               <div class="print-table-header-cell">Q. SUCCO 1ª</div>
               <div class="print-table-header-cell">DEST. SUCCO 1ª</div>
               <div class="print-table-header-cell">POLPA</div>
               <div class="print-table-header-cell">°BX</div>
               <div class="print-table-header-cell">BIO</div>
               <div class="print-table-header-cell">PAST.</div>
               <div class="print-table-header-cell">CONSERV.</div>
               <div class="print-table-header-cell">NOTE</div>
           </div>
       </div>
       <div class="print-table-body" id="print-table-body">
           <!-- Le righe verranno generate dinamicamente -->
       </div>
   </div>

   <!-- SEZIONE RIEPILOGO PER LA STAMPA -->
   <div class="print-summary-footer" style="display: none;">
       <div class="print-summary-card">
           <div class="card-header">TOTALE SUCCO 2ª</div>
           <div class="print-summary-row">
               <span class="print-summary-label">Quantità:</span>
               <span id="print-succo-seconda-qty">0 kg</span>
           </div>
           <div class="print-summary-row">
               <span class="print-summary-label">Destinazione:</span>
               <span id="print-succo-seconda-dest">NAT IN TINI</span>
           </div>
           <div class="print-summary-row">
               <span class="print-summary-label">Polpa:</span>
               <span id="print-succo-seconda-polpa"><1%</span>
           </div>
           <div class="print-summary-row">
               <span class="print-summary-label">°BX:</span>
               <span id="print-succo-seconda-brix">NAT</span>
           </div>
           <div class="print-summary-row">
               <span class="print-summary-label">Pastorizzato:</span>
               <span id="print-succo-seconda-past">SI</span>
           </div>
           <div class="print-summary-row">
               <span class="print-summary-label">Conservato:</span>
               <span id="print-succo-seconda-cons">SI</span>
           </div>
           <div class="print-summary-row">
               <span class="print-summary-label">Note:</span>
               <span id="print-succo-seconda-note">SERB. ESTERNI</span>
           </div>
       </div>

       <div class="print-torchiato-card">
           <div class="card-header">TOTALE TORCHIATO</div>
           <div class="print-summary-row">
               <span class="print-summary-label">Quantità:</span>
               <span id="print-torchiato-qty">0 kg</span>
           </div>
           <div class="print-summary-row">
               <span class="print-summary-label">Destinazione:</span>
               <span id="print-torchiato-dest">CONCENTRATO</span>
           </div>
           <div class="print-summary-row">
               <span class="print-summary-label">Polpa:</span>
               <span id="print-torchiato-polpa"><1%</span>
           </div>
           <div class="print-summary-row">
               <span class="print-summary-label">°BX:</span>
               <span id="print-torchiato-brix">45</span>
           </div>
           <div class="print-summary-row">
               <span class="print-summary-label">Pastorizzato:</span>
               <span id="print-torchiato-past">SI</span>
           </div>
           <div class="print-summary-row">
               <span class="print-summary-label">Conservato:</span>
               <span id="print-torchiato-cons">NO</span>
           </div>
           <div class="print-summary-row">
               <span class="print-summary-label">Note:</span>
               <span id="print-torchiato-note">-</span>
           </div>
       </div>
   </div>

   <!-- Modal selezione fornitore per destinazione -->
   <div id="supplier-selection-modal" class="modal-backdrop">
       <div class="modal-content">
           <div class="modal-header">
               Seleziona Fornitore per Destinazione
           </div>
           <div class="modal-body">
               <label for="supplier-select" class="form-label">Scegli il fornitore di riferimento:</label>
               <select id="supplier-select" class="form-select">
                   <option value="">Seleziona fornitore</option>
               </select>
           </div>
           <div class="modal-footer">
               <button type="button" class="btn btn-success" id="confirm-supplier-selection">
                   Conferma
               </button>
               <button type="button" class="btn btn-secondary" id="cancel-supplier-selection">
                   Annulla
               </button>
           </div>
       </div>
   </div>

   <!-- Input file nascosto -->
   <input type="file" id="file-input" accept=".json" style="display: none;">

<script>
$(document).ready(function() {
   let fornitoriData = {};
   let destinazioniData = {};
   let transferData = {};
   let transferredAmounts = {};
   let provenienzaData = {};
   let combinationData = {
       verde: { indexes: [], details: [], totalCombination: 0 },
       azzurro: { indexes: [], details: [], totalCombination: 0 },
       viola: { indexes: [], details: [], totalCombination: 0 }
   };
   
   // Rese per linea di trasformazione
   const yieldsPerLine = {
       'BOE/1100': { prima: 33, seconda: 5.0, torchiato: 6.0 },
       'GOE EST/400': { prima: 31.60, seconda: 0, torchiato: 6.0 },
       '400': { prima: 32.00, seconda: 0, torchiato: 6.0 },
       'GOE EST/POLY': { prima: 30.60, seconda: 0, torchiato: 6.0 },
       'GOE INT/POLY': { prima: 28.30, seconda: 0, torchiato: 6.0 },
       'BIRILLATRICI': { prima: 26.60, seconda: 0, torchiato: 6.0 },
       'GOE EST/BIRILLATRICI': { prima: 25.60, seconda: 0, torchiato: 6.0 }
   };

   // Definizione varietà per ogni tipo di agrume
   const varietyOptions = {
       'LIMONE': ['VERDELLO', 'FEMMINELLO', 'INTERDONATO', 'BIANCHETTO', 'MONACHELLO', 'VARIE', 'ALTRO'],
       'MANDARINO': ['TARD. DI CIACULLI', 'AVANA', 'CLEMENTINO', 'VARIE', 'ALTRO'],
       'ARANCIA': ['BIONDA', 'ROSSA', 'MORO', 'SANGUINELLA', 'TAROCCO', 'VARIE', 'ALTRO'],
       'BERGAMOTTO': ['FEMMINELLO', 'CASTAGNARO', 'VARIE', 'ALTRO'],
       'POMPELMO': ['GIALLO', 'ROSA', 'VARIE', 'ALTRO']
   };

   // Inizializzazione
   function initApp() {
       const today = new Date();
       $('#current-date').text(today.toLocaleDateString('it-IT', {
           weekday: 'long',
           year: 'numeric',
           month: 'long',
           day: 'numeric'
       }));
       $('#data-lavorazione').val(today.toISOString().split('T')[0]);
       updateLastRevision();
       updateElementsCount();
       initializePagesContainer();
   }

   function updateLastRevision() {
       const now = new Date();
       $('#last-revision').text(now.toLocaleDateString('it-IT') + ' - ' + now.toLocaleTimeString('it-IT'));
   }

   function updateElementsCount() {
       const count = $('.supplier-card, .destination-card').length;
       $('#elements-count').text(count);
       
       const pages = Math.ceil(count / 8) || 1;
       $('#pages-count').text(pages);
   }

   // NUOVA: Inizializza il container delle pagine
   function initializePagesContainer() {
       $('#pages-container').empty();
       createNewPage();
   }

   // NUOVA: Crea una nuova pagina
   function createNewPage() {
       const pageNumber = $('.main-grid').length + 1;
       const newPage = `
           <div class="main-grid page-${pageNumber}" data-page="${pageNumber}">
               <!-- Le card verranno inserite qui dinamicamente -->
           </div>
       `;
       $('#pages-container').append(newPage);
       return pageNumber;
   }

   // NUOVA: Riorganizza le card con posizionamento prioritario
   function reorganizeCardsWithPriority() {
       // Raccogli tutte le card esistenti
       const allCards = $('.supplier-card, .destination-card').detach();
       
       // Separa le card per tipo
       const supplierCards = allCards.filter('.supplier-card');
       const destinationCards = allCards.filter('.destination-card');
       
       // Combina le card con priorità: fornitori prima, destinazioni dopo
       const orderedCards = [
           ...supplierCards.toArray(),
           ...destinationCards.toArray()
       ];
       
       // Pulisci tutte le pagine
       $('.main-grid').empty();
       
       // Distribuisci le card nelle pagine (8 per pagina)
       let currentPageIndex = 0;
       let currentPositionInPage = 0;
       
       orderedCards.forEach((card, index) => {
           // Se abbiamo riempito la pagina corrente, crea una nuova pagina
           if (currentPositionInPage >= 8) {
               currentPageIndex++;
               currentPositionInPage = 0;
           }
           
           // Se non esiste la pagina, creala
           if ($('.main-grid').length <= currentPageIndex) {
               createNewPage();
           }
           
           // Rimuovi tutte le classi di posizione precedenti
           $(card).removeClass('card-position-1 card-position-2 card-position-3 card-position-4 card-position-5 card-position-6 card-position-7 card-position-8');
           
           // Aggiungi la nuova classe di posizione
           $(card).addClass(`card-position-${currentPositionInPage + 1}`);
           
           // Aggiungi la card alla pagina corrente
           $(`.main-grid[data-page="${currentPageIndex + 1}"]`).append(card);
           
           currentPositionInPage++;
       });
       
       updateElementsCount();
   }

   // MODIFICATA: Funzione per ottenere la prima posizione libera (ora illimitata)
   function getNextAvailablePosition() {
       const totalCards = $('.supplier-card, .destination-card').length;
       const currentPageIndex = Math.floor(totalCards / 8);
       const positionInPage = totalCards % 8;
       
       // Se la pagina corrente è piena, crea una nuova pagina
       if (positionInPage === 0 && totalCards > 0) {
           createNewPage();
       }
       
       return {
           pageIndex: currentPageIndex,
           position: positionInPage + 1
       };
   }

   // MODIFICATA: Funzione per generare un numero fornitore progressivo
   function getNextSupplierNumber() {
       let maxSupplierNumber = 0;
       $('.supplier-card').each(function() {
           const supplierNumber = parseInt($(this).data('supplier-number')) || 0;
           if (supplierNumber > maxSupplierNumber) {
               maxSupplierNumber = supplierNumber;
           }
       });
       return maxSupplierNumber + 1;
   }

   // MODIFICATA: Funzione per generare un cardIndex univoco
   function getNextCardIndex() {
       let maxIndex = 0;
       $('.supplier-card, .destination-card').each(function() {
           const cardIndex = parseInt($(this).data('card-index')) || 0;
           if (cardIndex > maxIndex) {
               maxIndex = cardIndex;
           }
       });
       return maxIndex + 1;
   }

   // NUOVA: Funzione per aggiornare le numerazioni delle destinazioni
   function updateDestinationHeaders() {
       $('.destination-card').each(function() {
           const cardIndex = $(this).data('card-index');
           const selectedSupplier = $(this).data('selected-supplier');
           
           if (selectedSupplier) {
               const supplierCard = $(`.supplier-card[data-card-index="${selectedSupplier}"]`);
               const supplierNumber = supplierCard.data('supplier-number') || selectedSupplier;
               
               let destCount = 0;
               $('.destination-card').each(function() {
                   const thisSupplier = $(this).data('selected-supplier');
                   const thisIndex = $(this).data('card-index');
                   if (thisSupplier === selectedSupplier && thisIndex <= cardIndex) {
                       destCount++;
                   }
               });
               
               $(this).find('.dest-card-header').text(`${destCount}ª Destinazione F${supplierNumber}`);
           } else {
               $(this).find('.dest-card-header').text('Destinazione non assegnata');
           }
       });
   }

   // MODIFICATA: Crea card fornitore con numero progressivo
   function createSupplierCard(cardIndex, supplierNumber) {
       const agrume = $('#tipo-agrume').val();
       let varietyOptionsHtml = '<option value="">Seleziona varietà</option>';
       
       if (agrume && varietyOptions[agrume]) {
           varietyOptions[agrume].forEach(variety => {
               varietyOptionsHtml += `<option value="${variety}">${variety}</option>`;
           });
       }

       return `
           <div class="supplier-card" data-card-index="${cardIndex}" data-card-type="supplier" data-supplier-number="${supplierNumber}">
               <div class="card-header">Fornitore ${supplierNumber}</div>
               
               <div class="form-row">
                   <span class="form-label">Nome:</span>
                   <div class="form-input">
                       <select class="nome-fornitore" onchange="updateSupplier(${cardIndex})">
                           <option value="">Seleziona fornitore</option>
                           <option value="RESTUCCIA">RESTUCCIA</option>
                           <option value="CI">CI</option>
                           <option value="ARCO">ARCO</option>
                           <option value="GIOVINAZZO">GIOVINAZZO</option>
                           <option value="AZ.T.C.">AZ.T.C.</option>
                           <option value="M.B.T.F.">M.B.T.F.</option>
                           <option value="VASTA">VASTA</option>
                           <option value="APAL">APAL</option>
                           <option value="GEIMA">GEIMA</option>
                           <option value="GEIMA+APAL">GEIMA+APAL</option>
                           <option value="UNIONBERG">UNIONBERG</option>
                           <option value="ALTRO">ALTRO</option>
                       </select>
                       <input type="text" class="altro-fornitore hidden-field" placeholder="Altro fornitore" style="margin-top: 3px; font-size: 11px;">
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Entrata (kg):</span>
                   <div class="form-input">
                       <input type="number" class="quantita-entrata" min="0" onchange="calculateSupplier(${cardIndex})">
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Trasformata (kg):</span>
                   <div class="form-input">
                       <input type="number" class="quantita-trasformata" min="0" onchange="calculateSupplier(${cardIndex})">
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Giacenza (kg):</span>
                   <div class="form-input">
                       <input type="number" class="giacenza calculated-field" readonly>
                   </div>
               </div>

               <div class="section-divider"></div>

               <div class="form-row">
                   <span class="form-label">Certificazione:</span>
                   <div class="form-input">
                       <select class="certificazione" onchange="updateBioStyle(${cardIndex})">
                           <option value="">Seleziona</option>
                           <option value="BIO EU">BIO EU</option>
                           <option value="BIO DEM">BIO DEM</option>
                           <option value="BIO NTD">BIO NTD</option>
                           <option value="BIO DEM/NTD">BIO DEM/NTD</option>
                           <option value="TRACCIATO">TRACCIATO</option>
                           <option value="BIO IGP">BIO IGP</option>
                           <option value="IGP">IGP</option>
                           <option value="CONVENZIONALE">CONVENZIONALE</option>
                           <option value="ALTRO">ALTRO</option>
                       </select>
                       <input type="text" class="altra-certificazione hidden-field" placeholder="Altra certificazione" style="margin-top: 3px; font-size: 11px;">
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Varietà:</span>
                   <div class="form-input">
                       <select class="varieta" onchange="toggleAltroVarieta(${cardIndex})">
                           ${varietyOptionsHtml}
                       </select>
                       <input type="text" class="altra-varieta hidden-field" placeholder="Altra varietà" style="margin-top: 3px; font-size: 11px;">
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Linea:</span>
                   <div class="form-input">
                       <select class="linea" onchange="updateYield(${cardIndex}); calculateSupplier(${cardIndex}); updateBioStyle(${cardIndex})">
                           <option value="">Seleziona linea</option>
                           <option value="GOE EST/400">GOE EST/400</option>
                           <option value="400">400</option>
                           <option value="BOE/1100">BOE/1100</option>
                           <option value="GOE EST/POLY">GOE EST/POLY</option>
                           <option value="GOE INT/POLY">GOE INT/POLY</option>
                           <option value="BIRILLATRICI">BIRILLATRICI</option>
                           <option value="GOE EST/BIRILLATRICI">GOE EST/BIRILLATRICI</option>
                       </select>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Portata (kg/h):</span>
                   <div class="form-input">
                       <input type="number" class="portata" onchange="calculateTime(${cardIndex})">
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Inizio:</span>
                   <div class="form-input">
                       <input type="time" class="orario-inizio" onchange="calculateTime(${cardIndex})">
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Fine:</span>
                   <div class="form-input">
                       <input type="text" class="orario-fine calculated-field" readonly>
                   </div>
               </div>

               <div class="section-divider"></div>

               <div class="form-row">
                   <span class="form-label">Succo 1ª (kg):</span>
                   <div class="form-input">
                       <input type="number" class="succo-prima yield-result" readonly>
                       <div class="transfer-details hidden-field"></div>
                       <div class="combination-details hidden-field"></div>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Dest.:</span>
                   <div class="form-input">
                       <select class="destinazione-prima" onchange="updateDestinationCard(${cardIndex})">
                           <option value="">Destinazione succo 1ª</option>
                           <option value="NAT IN TINI">NAT IN TINI</option>
                           <option value="PET 100">PET 100</option>
                           <option value="PET 200">PET 200</option>
                           <option value="PET 480">PET 480</option>
                           <option value="ACMA">ACMA</option>
                           <option value="REX">REX</option>
                           <option value="GOGLIO">GOGLIO</option>
                           <option value="VASCHETTE">VASCHETTE</option>
                           <option value="VASCHETTE ZUCCHERATE">VASCHETTE ZUCCHERATE</option>
                           <option value="LATTE">LATTE</option>
                           <option value="F.F.">F.F.</option>
                           <option value="F.T.C">F.T.C</option>
                           <option value="FBL">FBL</option>
                           <option value="BIC">BIC</option>
                           <option value="CISTERNA P">CISTERNA P</option>
                           <option value="CISTERNA EF">CISTERNA EF</option>
                           <option value="CISTERNA VK">CISTERNA VK</option>
                           <option value="CISTERNA GS">CISTERNA GS</option>
                           <option value="CISTERNA CARTH.">CISTERNA CARTH.</option>
                           <option value="CONCENTRATO">CONCENTRATO</option>
                           <option value="ALTRO">ALTRO</option>
                       </select>
                       <input type="text" class="altra-destinazione hidden-field" placeholder="Altra destinazione" style="margin-top: 3px; font-size: 11px;">
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Polpa:</span>
                   <div class="form-input">
                       <select class="tenore-polpa-prima">
                           <option value="STANDARD">STANDARD</option>
                           <option value="LIMPIDO">LIMPIDO</option>
                           <option value="SEMICLEAR">SEMICLEAR</option>
                           <option value="<1%"><1%</option>
                           <option value="2%">2%</option>
                           <option value="3%">3%</option>
                           <option value="6%">6%</option>
                           <option value="ALTRO">ALTRO</option>
                       </select>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">°BX:</span>
                   <div class="form-input">
                       <select class="brix-prima">
                           <option value="NAT">NAT</option>
                           <option value="20">20</option>
                           <option value="32">32</option>
                           <option value="40">40</option>
                           <option value="41">41</option>
                           <option value="45">45</option>
                           <option value="55">55</option>
                           <option value="58">58</option>
                           <option value="60">60</option>
                           <option value="63.5">63.5</option>
                           <option value="65">65</option>
                           <option value="ALTRO">ALTRO</option>
                       </select>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Bio:</span>
                   <div class="form-input">
                       <select class="bio-prima" onchange="updateDestinationCard(${cardIndex})">
                           <option value="SI">SI</option>
                           <option value="NO">NO</option>
                           <option value="DECLASSATO">DECLASSATO</option>
                       </select>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Pastorizzato:</span>
                   <div class="form-input">
                       <select class="pastorizzato-prima">
                           <option value="SI">SI</option>
                           <option value="NO">NO</option>
                       </select>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Conservato:</span>
                   <div class="form-input">
                       <select class="conservato-prima">
                           <option value="SI">SI</option>
                           <option value="NO" selected>NO</option>
                       </select>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Note:</span>
                   <div class="form-input">
                       <textarea class="note-prima" placeholder="Note succo 1ª" rows="2"></textarea>
                   </div>
               </div>

               <div class="remaining-qty">Rimanente: <span class="remaining-value">0</span> kg</div>

               <div class="transfer-section">
                   <div class="transfer-row">
                       <span style="font-size: 11px; font-weight: bold;">Invia a:</span>
                       <select class="transfer-dest">
                           <option value="">Dest.</option>
                       </select>
                       <input type="number" class="transfer-qty" placeholder="kg" min="0" step="0.1">
                       <button type="button" class="btn btn-success" onclick="executeTransfer(${cardIndex})">
                           Trasf.
                       </button>
                   </div>
               </div>

               <div class="card-buttons">
                   <button type="button" class="btn btn-warning" onclick="resetCard(${cardIndex})">
                       Reset
                   </button>
                   <button type="button" class="btn btn-danger" onclick="removeCard(${cardIndex})">
                       Rimuovi
                   </button>
               </div>
           </div>
       `;
   }

   // Crea card destinazione
   function createDestinationCard(cardIndex, selectedSupplier) {
       return `
           <div class="destination-card" data-card-index="${cardIndex}" data-card-type="destination" data-selected-supplier="${selectedSupplier || ''}">
               <div class="dest-card-header">Destinazione non assegnata</div>
               
               <!-- Provenienza -->
               <div class="provenienza-info" id="provenienza-${cardIndex}">
                   Nessuna provenienza
               </div>
               
               <!-- Quantità Succo 1ª -->
               <div class="form-row">
                   <span class="form-label">Succo 1ª (kg):</span>
                   <div class="form-input">
                       <input type="number" class="quantita-prima-dest" min="0" step="0.1" onchange="updateDestBioStyles(${cardIndex})">
                   </div>
               </div>

               <div class="section-divider"></div>

               <!-- Destinazione Succo 1ª -->
               <div class="form-row">
                   <span class="form-label">Dest. Succo 1ª:</span>
                   <div class="form-input">
                       <select class="destinazione-succo" onchange="toggleAltroDestinazione(${cardIndex}); updateDestBioStyles(${cardIndex})">
                           <option value="">Seleziona destinazione</option>
                           <option value="NAT IN TINI">NAT IN TINI</option>
                           <option value="PET 100">PET 100</option>
                           <option value="PET 200">PET 200</option>
                           <option value="PET 480">PET 480</option>
                           <option value="ACMA">ACMA</option>
                           <option value="REX">REX</option>
                           <option value="GOGLIO">GOGLIO</option>
                           <option value="VASCHETTE">VASCHETTE</option>
                           <option value="VASCHETTE ZUCCHERATE">VASCHETTE ZUCCHERATE</option>
                           <option value="LATTE">LATTE</option>
                           <option value="F.F.">F.F.</option>
                           <option value="F.T.C">F.T.C</option>
                           <option value="FBL">FBL</option>
                           <option value="BIC">BIC</option>
                           <option value="CISTERNA P">CISTERNA P</option>
                           <option value="CISTERNA EF">CISTERNA EF</option>
                           <option value="CISTERNA VK">CISTERNA VK</option>
                           <option value="CISTERNA GS">CISTERNA GS</option>
                           <option value="CISTERNA CARTH.">CISTERNA CARTH.</option>
                           <option value="CONCENTRATO">CONCENTRATO</option>
                           <option value="ALTRO">ALTRO</option>
                       </select>
                       <input type="text" class="altra-destinazione-text hidden-field" placeholder="Altra destinazione" style="margin-top: 3px; font-size: 11px;">
                   </div>
               </div>

               <div class="section-divider"></div>

               <!-- Caratteristiche prodotti -->
               <div class="form-row">
                   <span class="form-label">Polpa:</span>
                   <div class="form-input">
                       <select class="tenore-polpa" onchange="toggleAltroTenore(${cardIndex})">
                           <option value="STANDARD">STANDARD</option>
                           <option value="LIMPIDO">LIMPIDO</option>
                           <option value="<1%"><1%</option>
                           <option value="2%">2%</option>
                           <option value="3%">3%</option>
                           <option value="6%">6%</option>
                           <option value="ALTRO">ALTRO</option>
                       </select>
                       <input type="text" class="altro-tenore-text hidden-field" placeholder="Altro tenore" style="margin-top: 3px; font-size: 11px;">
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">°BX:</span>
                   <div class="form-input">
                       <select class="brix" onchange="toggleAltroBrix(${cardIndex})">
                           <option value="NAT">NAT</option>
                           <option value="20">20</option>
                           <option value="32">32</option>
                           <option value="40">40</option>
                           <option value="45">45</option>
                           <option value="48">48</option>
                           <option value="50">50</option>
                           <option value="55">55</option>
                           <option value="60">60</option>
                           <option value="65">65</option>
                           <option value="ALTRO">ALTRO</option>
                       </select>
                       <input type="text" class="altro-brix-text hidden-field" placeholder="Altro Brix" style="margin-top: 3px; font-size: 11px;">
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Bio:</span>
                   <div class="form-input">
                       <select class="bio" onchange="updateDestBioStyles(${cardIndex})">
                           <option value="SI">SI</option>
                           <option value="NO">NO</option>
                           <option value="DECLASSATO">DECLASSATO</option>
                       </select>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Pastorizzato:</span>
                   <div class="form-input">
                       <select class="pastorizzato">
                           <option value="SI">SI</option>
                           <option value="NO">NO</option>
                       </select>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Conservato:</span>
                   <div class="form-input">
                       <select class="conservato">
                           <option value="SI">SI</option>
                           <option value="NO" selected>NO</option>
                       </select>
                   </div>
               </div>

               <div class="form-row">
                   <span class="form-label">Note:</span>
                   <div class="form-input">
                       <textarea class="note" placeholder="Note destinazione" rows="2"></textarea>
                   </div>
               </div>

               <div class="card-buttons">
                   <button type="button" class="btn btn-warning" onclick="resetCard(${cardIndex})">
                       Reset
                   </button>
                   <button type="button" class="btn btn-danger" onclick="removeCard(${cardIndex})">
                       Rimuovi
                   </button>
               </div>
           </div>
       `;
   }

   // NUOVA: Gestione modal selezione fornitore
   function showSupplierSelectionModal() {
       return new Promise((resolve, reject) => {
           const modal = $('#supplier-selection-modal');
           const select = $('#supplier-select');
           
           // Popola lista fornitori
           select.empty().append('<option value="">Seleziona fornitore</option>');
           
           $('.supplier-card').each(function() {
               const cardIndex = $(this).data('card-index');
               const supplierNumber = $(this).data('supplier-number');
               const nome = $(this).find('.nome-fornitore').val();
               const altroNome = $(this).find('.altro-fornitore').val();
               
               let displayName = '';
               if (nome === 'ALTRO' && altroNome) {
                   displayName = altroNome;
               } else if (nome && nome !== 'ALTRO') {
                   displayName = nome;
               }
               
               if (displayName) {
                   select.append(`<option value="${cardIndex}">F${supplierNumber} - ${displayName}</option>`);
               }
           });
           
           if (select.find('option').length === 1) {
               reject('Nessun fornitore disponibile');
               return;
           }
           
           modal.fadeIn();
           
           $('#confirm-supplier-selection').off('click').on('click', function() {
               const selectedSupplier = select.val();
               if (!selectedSupplier) {
                   alert('Seleziona un fornitore');
                   return;
               }
               modal.fadeOut();
               resolve(selectedSupplier);
           });
           
           $('#cancel-supplier-selection').off('click').on('click', function() {
               modal.fadeOut();
               reject('Operazione annullata');
           });
       });
   }

   // Gestione campi "ALTRO"
   window.toggleAltroVarieta = function(cardIndex) {
       const card = $(`.supplier-card[data-card-index="${cardIndex}"]`);
       const varieta = card.find('.varieta').val();
       const altroField = card.find('.altra-varieta');
       
       if (varieta === 'ALTRO') {
           altroField.removeClass('hidden-field');
       } else {
           altroField.addClass('hidden-field').val('');
       }
   };

   window.toggleAltroDestinazione = function(cardIndex) {
       const card = $(`.destination-card[data-card-index="${cardIndex}"]`);
       const dest = card.find('.destinazione-succo').val();
       const altroField = card.find('.altra-destinazione-text');
       
       if (dest === 'ALTRO') {
           altroField.removeClass('hidden-field');
       } else {
           altroField.addClass('hidden-field').val('');
       }
   };

   window.toggleAltroTenore = function(cardIndex) {
       const card = $(`.destination-card[data-card-index="${cardIndex}"]`);
       const tenore = card.find('.tenore-polpa').val();
       const altroField = card.find('.altro-tenore-text');
       
       if (tenore === 'ALTRO') {
           altroField.removeClass('hidden-field');
       } else {
           altroField.addClass('hidden-field').val('');
       }
   };

   window.toggleAltroBrix = function(cardIndex) {
       const card = $(`.destination-card[data-card-index="${cardIndex}"]`);
       const brix = card.find('.brix').val();
       const altroField = card.find('.altro-brix-text');
       
       if (brix === 'ALTRO') {
           altroField.removeClass('hidden-field');
       } else {
           altroField.addClass('hidden-field').val('');
       }
   };

   // MODIFICATA: Aggiorna resa in base alla linea
   window.updateYield = function(cardIndex) {
       const card = $(`.supplier-card[data-card-index="${cardIndex}"]`);
       const linea = card.find('.linea').val();
       
       if (linea && yieldsPerLine[linea]) {
           fornitoriData[cardIndex] = fornitoriData[cardIndex] || {};
           fornitoriData[cardIndex].resa = yieldsPerLine[linea];
       }
   };

   // MODIFICATA: Calcola valori fornitore
   window.calculateSupplier = function(cardIndex) {
       const card = $(`.supplier-card[data-card-index="${cardIndex}"]`);
       
       const entrata = parseFloat(card.find('.quantita-entrata').val()) || 0;
       const trasformata = parseFloat(card.find('.quantita-trasformata').val()) || 0;
       const giacenza = entrata - trasformata;
       
       card.find('.giacenza').val(giacenza >= 0 ? giacenza : 0);
       
       // Calcola succo 1ª
       const linea = card.find('.linea').val();
       const resa = fornitoriData[cardIndex]?.resa?.prima || (yieldsPerLine[linea]?.prima || 30);
       const succoField = card.find('.succo-prima');
       
       if (trasformata > 0 && !succoField.hasClass('combination-result')) {
           const succo = (trasformata * resa / 100).toFixed(1);
           succoField.val(succo);
       } else if (trasformata === 0 && !succoField.hasClass('combination-result')) {
           succoField.val('');
       }
       
       updateTotals();
       updateDestinationCard(cardIndex);
       calculateTime(cardIndex);
       updateSummaryCards();
   };

   // NUOVA: Aggiorna totali nelle card riepilogo
   function updateSummaryCards() {
       let totalSeconda = 0;
       let totalTorchiato = 0;
       
       $('.supplier-card').each(function() {
           const trasformata = parseFloat($(this).find('.quantita-trasformata').val()) || 0;
           const linea = $(this).find('.linea').val();
           
           if (trasformata > 0 && linea) {
               const yields = yieldsPerLine[linea];
               if (yields) {
                   if (yields.seconda > 0) {
                       totalSeconda += (trasformata * yields.seconda / 100);
                   }
                   if (yields.torchiato > 0) {
                       totalTorchiato += (trasformata * yields.torchiato / 100);
                   }
               }
           }
       });
       
       $('.totale-succo-seconda').val(totalSeconda.toFixed(1));
       $('.totale-torchiato').val(totalTorchiato.toFixed(1));
       
       // Aggiorna anche i valori per la stampa
       updatePrintSummary();
   }

   // NUOVA: Aggiorna valori per la stampa
   function updatePrintSummary() {
       const totalSeconda = parseFloat($('.totale-succo-seconda').val()) || 0;
       const totalTorchiato = parseFloat($('.totale-torchiato').val()) || 0;
       
       $('#print-succo-seconda-qty').text(totalSeconda.toFixed(1) + ' kg');
       $('#print-succo-seconda-dest').text($('.destinazione-totale-seconda').val() || 'NAT IN TINI');
       $('#print-succo-seconda-polpa').text($('.tenore-polpa-seconda').val() || '<1%');
       $('#print-succo-seconda-brix').text($('.brix-seconda').val() || 'NAT');
       $('#print-succo-seconda-past').text($('.pastorizzato-seconda').val() || 'SI');
       $('#print-succo-seconda-cons').text($('.conservato-seconda').val() || 'SI');
       $('#print-succo-seconda-note').text($('.note-seconda').val() || 'SERB. ESTERNI');
       
       $('#print-torchiato-qty').text(totalTorchiato.toFixed(1) + ' kg');
       $('#print-torchiato-dest').text($('.destinazione-totale-torchiato').val() || 'CONCENTRATO');
       $('#print-torchiato-polpa').text($('.tenore-polpa-torchiato').val() || '<1%');
       $('#print-torchiato-brix').text($('.brix-torchiato').val() || '45');
       $('#print-torchiato-past').text($('.pastorizzato-torchiato').val() || 'SI');
       $('#print-torchiato-cons').text($('.conservato-torchiato').val() || 'NO');
       $('#print-torchiato-note').text($('.note-torchiato').val() || '-');
   }

   // MODIFICATA: Calcola orari con arrotondamento al quarto d'ora superiore
   window.calculateTime = function(cardIndex) {
       const card = $(`.supplier-card[data-card-index="${cardIndex}"]`);
       const trasformata = parseFloat(card.find('.quantita-trasformata').val()) || 0;
       const portata = parseFloat(card.find('.portata').val()) || 0;
       const inizio = card.find('.orario-inizio').val();
       
       if (trasformata > 0 && portata > 0 && inizio) {
           const durata = Math.round((trasformata / portata) * 60);
           const [ore, minuti] = inizio.split(':').map(n => parseInt(n));
           const inizioMinuti = ore * 60 + minuti;
           const fineMinuti = inizioMinuti + durata;
           
           let oreFine = Math.floor(fineMinuti / 60) % 24;
           let minutiFine = fineMinuti % 60;
           
           // ARROTONDAMENTO AL QUARTO D'ORA SUPERIORE
           if (minutiFine > 0) {
               const quartiDora = Math.ceil(minutiFine / 15);
               minutiFine = quartiDora * 15;
               
               if (minutiFine >= 60) {
                   oreFine += Math.floor(minutiFine / 60);
                   minutiFine = minutiFine % 60;
                   oreFine = oreFine % 24;
               }
           }
           
           let orarioFine = `${oreFine.toString().padStart(2, '0')}:${minutiFine.toString().padStart(2, '0')}`;
           
           if (fineMinuti >= 1440) {
               orarioFine += ' (g.succ.)';
           }
           
           card.find('.orario-fine').val(orarioFine);
       } else {
           card.find('.orario-fine').val('');
       }
   };

   // MODIFICATA: Aggiorna stili bio
   window.updateBioStyle = function(cardIndex) {
       const card = $(`.supplier-card[data-card-index="${cardIndex}"]`);
       const cert = card.find('.certificazione').val();
       const nome = card.find('.nome-fornitore').val();
       const supplierNumber = card.data('supplier-number');
       
       // Reset stili
       card.find('.certificazione, .varieta, .linea').removeClass('bio-red-field bio-black-field');
       card.find('.form-label').removeClass('bio-red-text bio-black-text');
       
       // Gestisci campo altro certificazione
       const altroField = card.find('.altra-certificazione');
       if (cert === 'ALTRO') {
           altroField.removeClass('hidden-field');
       } else {
           altroField.addClass('hidden-field').val('');
       }
       
       // Applica stili bio
       if (cert && cert.includes('BIO')) {
           card.find('.certificazione, .varieta, .linea').addClass('bio-red-field');
       }
       
       // Aggiorna header con nome
       if (nome) {
           card.find('.card-header').text(`F${supplierNumber} - ${nome}`);
       } else {
           card.find('.card-header').text(`Fornitore ${supplierNumber}`);
       }
       
       updateCombinazioneOptions();
   };

   // Aggiorna stili bio destinazione
   window.updateDestBioStyles = function(cardIndex) {
       const card = $(`.destination-card[data-card-index="${cardIndex}"]`);
       const bioStatus = card.find('.bio').val();
       
       // Reset stili
       card.find('input, select, textarea').removeClass('bio-red-field bio-black-field');
       card.find('.form-label').removeClass('bio-red-text bio-black-text');
       
       // Applica colori in base al bio status
       if (bioStatus === 'SI') {
           card.find('input, select, textarea').addClass('bio-red-field');
           card.find('.form-label').addClass('bio-red-text');
       } else if (bioStatus === 'DECLASSATO' || bioStatus === 'NO') {
           card.find('.bio').addClass('bio-black-field');
       }
   };

   // Aggiorna fornitore
   window.updateSupplier = function(cardIndex) {
       const card = $(`.supplier-card[data-card-index="${cardIndex}"]`);
       const nome = card.find('.nome-fornitore').val();
       const altroField = card.find('.altro-fornitore');
       
       if (nome === 'ALTRO') {
           altroField.removeClass('hidden-field');
       } else {
           altroField.addClass('hidden-field').val('');
       }
       
       updateBioStyle(cardIndex);
       updateTransferOptions();
   };

   // MODIFICATA: Aggiorna card destinazione con combinazioni - MOSTRA TOTALE COMBINAZIONE NEL RIMANENTE
   window.updateDestinationCard = function(cardIndex) {
       const card = $(`.supplier-card[data-card-index="${cardIndex}"]`);
       let quantitaPrima = parseFloat(card.find('.succo-prima').val()) || 0;
       let totalCombination = 0;
       
       // Se è parte di una combinazione, usa il totale della combinazione nel rimanente
       const combinationType = card.find('.succo-prima').attr('data-combination-type');
       if (combinationType && combinationData[combinationType] && combinationData[combinationType].totalCombination > 0) {
           totalCombination = combinationData[combinationType].totalCombination;
       }
       
       const totalTransferred = transferredAmounts[cardIndex] || 0;
       
       // Se c'è una combinazione attiva, mostra il totale della combinazione nel rimanente
       const availableForDisplay = totalCombination > 0 ? totalCombination : quantitaPrima;
       const remaining = availableForDisplay - totalTransferred;
       
       card.find('.remaining-value').text(`${remaining.toFixed(1)} (Tot: ${totalCombination > 0 ? totalCombination.toFixed(1) : quantitaPrima.toFixed(1)})`);
       
       const transferQtyField = card.find('.transfer-qty');
       if (remaining > 0) {
           transferQtyField.val(remaining.toFixed(1));
       } else {
           transferQtyField.val('');
       }
       
       // Gestisci campo altro destinazione
       const altroField = card.find('.altra-destinazione');
       if (card.find('.destinazione-prima').val() === 'ALTRO') {
           altroField.removeClass('hidden-field');
       } else {
           altroField.addClass('hidden-field').val('');
       }
       
       updateTransferOptions();
   };

   // Aggiorna totali
   function updateTotals() {
       let totaleEntrata = 0;
       let totaleTrasformata = 0;
       let totaleGiacenza = 0;
       
       $('.supplier-card').each(function() {
           totaleEntrata += parseFloat($(this).find('.quantita-entrata').val()) || 0;
           totaleTrasformata += parseFloat($(this).find('.quantita-trasformata').val()) || 0;
           totaleGiacenza += parseFloat($(this).find('.giacenza').val()) || 0;
       });
       
       $('#entrata-totale').text(totaleEntrata);
       $('#trasformata-totale').text(totaleTrasformata);
       $('#giacenza-totale').text(totaleGiacenza);
   }

   // MODIFICATA: Aggiorna opzioni trasferimento con numeri fornitori
   function updateTransferOptions() {
       $('.transfer-dest').each(function() {
           const sourceCardIndex = $(this).closest('.supplier-card').data('card-index');
           $(this).empty().append('<option value="">Dest.</option>');
           
           // Aggiungi fornitori (escluso il fornitore corrente)
           $('.supplier-card').each(function() {
               const cardIndex = $(this).data('card-index');
               const supplierNumber = $(this).data('supplier-number');
               if (cardIndex !== sourceCardIndex) {
                   const nome = $(this).find('.nome-fornitore').val();
                   if (nome) {
                       $(`.supplier-card[data-card-index="${sourceCardIndex}"] .transfer-dest`)
                           .append(`<option value="F${cardIndex}">F${supplierNumber}</option>`);
                   }
               }
           });
           
           // Aggiungi destinazioni con numerazione corretta
           $('.destination-card').each(function() {
               const cardIndex = $(this).data('card-index');
               const selectedSupplier = $(this).data('selected-supplier');
               
               if (selectedSupplier) {
                   const supplierCard = $(`.supplier-card[data-card-index="${selectedSupplier}"]`);
                   const supplierNumber = supplierCard.data('supplier-number') || selectedSupplier;
                   
                   let destNumber = 1;
                   $('.destination-card').each(function() {
                       const thisSupplier = $(this).data('selected-supplier');
                       const thisIndex = $(this).data('card-index');
                       if (thisSupplier === selectedSupplier && thisIndex < cardIndex) {
                           destNumber++;
                       }
                   });
                   
                   $(`.supplier-card[data-card-index="${sourceCardIndex}"] .transfer-dest`)
                       .append(`<option value="D${cardIndex}">${destNumber}ª dest. F${supplierNumber}</option>`);
               } else {
                   $(`.supplier-card[data-card-index="${sourceCardIndex}"] .transfer-dest`)
                       .append(`<option value="D${cardIndex}">Dest.${cardIndex}</option>`);
               }
           });
       });
   }

   // MODIFICATA: Aggiorna opzioni combinazioni
   function updateCombinazioneOptions() {
       const selectVerde = $('#combinazione-fornitori-verde');
       const selectAzzurro = $('#combinazione-fornitori-azzurro');
       const selectViola = $('#combinazione-fornitori-viola');
       
       selectVerde.empty().append('<option value="">Seleziona combinazione Verde</option>');
       selectAzzurro.empty().append('<option value="">Seleziona combinazione Azzurro</option>');
       selectViola.empty().append('<option value="">Seleziona combinazione Viola</option>');
       
       const fornitori = [];
       $('.supplier-card').each(function() {
           const cardIndex = $(this).data('card-index');
           const supplierNumber = $(this).data('supplier-number');
           const nome = $(this).find('.nome-fornitore').val();
           const altroNome = $(this).find('.altro-fornitore').val();
           
           let nomeFornitore = '';
           if (nome === 'ALTRO' && altroNome) {
               nomeFornitore = altroNome;
           } else if (nome && nome !== 'ALTRO') {
               nomeFornitore = nome;
           }
           
           const certificazione = $(this).find('.certificazione').val() || 'N/D';
           const linea = $(this).find('.linea').val() || 'N/D';
           
           if (nomeFornitore) {
               fornitori.push({ 
                   cardIndex: cardIndex, 
                   supplierNumber: supplierNumber,
                   nome: nomeFornitore,
                   certificazione: certificazione,
                   linea: linea
               });
           }
       });
       
       // Combinazioni di 2 fornitori
       for (let i = 0; i < fornitori.length; i++) {
for (let j = i + 1; j < fornitori.length; j++) {
const combo = ${fornitori[i].cardIndex},${fornitori[j].cardIndex};
const label = F${fornitori[i].supplierNumber} - ${fornitori[i].nome} + F${fornitori[j].supplierNumber} - ${fornitori[j].nome};
selectVerde.append(<option value="${combo}">${label}</option>);
selectAzzurro.append(<option value="${combo}">${label}</option>);
selectViola.append(<option value="${combo}">${label}</option>);
}
}
   // Combinazioni di 3 fornitori
   for (let i = 0; i < fornitori.length; i++) {
       for (let j = i + 1; j < fornitori.length; j++) {
           for (let k = j + 1; k < fornitori.length; k++) {
               const combo = `${fornitori[i].cardIndex},${fornitori[j].cardIndex},${fornitori[k].cardIndex}`;
               const label = `F${fornitori[i].supplierNumber} - ${fornitori[i].nome} + F${fornitori[j].supplierNumber} - ${fornitori[j].nome} + F${fornitori[k].supplierNumber} - ${fornitori[k].nome}`;
               selectVerde.append(`<option value="${combo}">${label}</option>`);
               selectAzzurro.append(`<option value="${combo}">${label}</option>`);
               selectViola.append(`<option value="${combo}">${label}</option>`);
           }
       }
   }
}
function toggleCombinazioniSection() {
const hasSuppliers = $('.supplier-card').length > 0;
   if (hasSuppliers) {
       $('#combinazioni-section').removeClass('hidden-field');
   } else {
       $('#combinazioni-section').addClass('hidden-field');
   }
}
// Esegui trasferimento
window.executeTransfer = function(sourceCardIndex) {
const sourceCard = $(.supplier-card[data-card-index="${sourceCardIndex}"]);
const destValue = sourceCard.find('.transfer-dest').val();
const transferAmount = parseFloat(sourceCard.find('.transfer-qty').val()) || 0;
   if (!destValue || transferAmount <= 0) {
       alert('Seleziona destinazione e inserisci quantità valida');
       return;
   }
   
   const remainingText = sourceCard.find('.remaining-value').text();
   const remaining = parseFloat(remainingText.split('(')[0]) || 0;
   
   if (transferAmount > remaining) {
       alert('Quantità superiore al rimanente');
       return;
   }
   
   const sourceName = getCardDisplayName(sourceCard);
   const sourceSupplierNumber = sourceCard.data('supplier-number');
   
   // Determina se è fornitore o destinazione
   if (destValue.startsWith('F')) {
       // Trasferimento verso fornitore
       const targetCardIndex = destValue.replace('F', '');
       const targetCard = $(`.supplier-card[data-card-index="${targetCardIndex}"]`);
       
       if (targetCard.length === 0) {
           alert('Fornitore di destinazione non trovato');
           return;
       }
       
       const targetName = getCardDisplayName(targetCard);
       const targetSupplierNumber = targetCard.data('supplier-number');
       
       if (!confirm(`Confermi trasferimento di ${transferAmount} kg da F${sourceSupplierNumber} (${sourceName}) a F${targetSupplierNumber} (${targetName})?`)) {
           return;
       }
       
       // Aggiorna quantità destinazione
       const currentTargetQty = parseFloat(targetCard.find('.succo-prima').val()) || 0;
       const newTargetQty = currentTargetQty + transferAmount;
       targetCard.find('.succo-prima').val(newTargetQty.toFixed(1)).addClass('received-transfer');
       
       // Aggiorna dettagli trasferimento
       updateTransferDetails(targetCard, sourceCardIndex, sourceName, transferAmount, sourceSupplierNumber);
       
       // Salva trasferimento
       if (!transferData[targetCardIndex]) {
           transferData[targetCardIndex] = [];
       }
       transferData[targetCardIndex].push({
           fromCard: sourceCardIndex,
           fromName: sourceName,
           fromSupplierNumber: sourceSupplierNumber,
           amount: transferAmount,
           timestamp: new Date().toLocaleTimeString('it-IT')
       });
       
       updateDestinationCard(targetCardIndex);
       
       alert(`Trasferimento completato! ${transferAmount} kg trasferiti da F${sourceSupplierNumber} a F${targetSupplierNumber}\nNuova quantità F${targetSupplierNumber}: ${newTargetQty.toFixed(1)} kg`);
       
   } else if (destValue.startsWith('D')) {
       // Trasferimento verso destinazione
       const targetCardIndex = destValue.replace('D', '');
       const targetCard = $(`.destination-card[data-card-index="${targetCardIndex}"]`);
       
       if (targetCard.length === 0) {
           alert('Destinazione non trovata');
           return;
       }
       
       if (!confirm(`Confermi trasferimento di ${transferAmount} kg da F${sourceSupplierNumber} (${sourceName}) a Destinazione ${targetCardIndex}?`)) {
           return;
       }
       
       // Aggiorna quantità destinazione
       const currentTargetQty = parseFloat(targetCard.find('.quantita-prima-dest').val()) || 0;
       const newTargetQty = currentTargetQty + transferAmount;
       targetCard.find('.quantita-prima-dest').val(newTargetQty.toFixed(1));
       
       // Copia bio status dal fornitore sorgente
       const sourceBio = sourceCard.find('.bio-prima').val() || 'SI';
       targetCard.find('.bio').val(sourceBio);
       
       // Aggiorna provenienza
       if (!provenienzaData[targetCardIndex]) {
           provenienzaData[targetCardIndex] = [];
       }
       provenienzaData[targetCardIndex].push({
           fornitore: `F${sourceSupplierNumber} - ${sourceName}`,
           quantita: transferAmount
       });
       
       // Aggiorna visualizzazione provenienza
       const provenienzaText = provenienzaData[targetCardIndex]
           .map(p => `${p.fornitore}: ${p.quantita}kg`)
           .join(', ');
       $(`#provenienza-${targetCardIndex}`).text(`Provenienza: ${provenienzaText}`);
       
       updateDestBioStyles(targetCardIndex);
       
       alert(`Trasferimento completato! ${transferAmount} kg trasferiti da F${sourceSupplierNumber} a Destinazione ${targetCardIndex}\nNuova quantità: ${newTargetQty.toFixed(1)} kg`);
   }
   
   // Traccia quantità trasferita dal fornitore sorgente
   if (!transferredAmounts[sourceCardIndex]) {
       transferredAmounts[sourceCardIndex] = 0;
   }
   transferredAmounts[sourceCardIndex] += transferAmount;
   
   // Reset campi sorgente
   sourceCard.find('.transfer-dest').val('');
   sourceCard.find('.transfer-qty').val('');
   
   // Aggiorna rimanente fornitore sorgente
   updateDestinationCard(sourceCardIndex);
};
function getCardDisplayName(card) {
if (card.hasClass('supplier-card')) {
const nome = card.find('.nome-fornitore').val();
const altroNome = card.find('.altro-fornitore').val();
       if (nome === 'ALTRO' && altroNome) {
           return altroNome;
       } else if (nome && nome !== 'ALTRO') {
           return nome;
       }
       return 'N/D';
   }
   return 'Destinazione';
}
function updateTransferDetails(targetCard, sourceCardIndex, sourceName, amount, sourceSupplierNumber) {
const detailsContainer = targetCard.find('.transfer-details');
detailsContainer.removeClass('hidden-field');
   let currentDetails = detailsContainer.html();
   const newDetail = `<div><strong>+${amount} kg</strong> da F${sourceSupplierNumber} (${sourceName})</div>`;
   
   if (currentDetails) {
       detailsContainer.html(currentDetails + newDetail);
   } else {
       detailsContainer.html('<strong>Trasferimenti:</strong>' + newDetail);
   }
}
// Gestione combinazioni
function getLastCardInCombination(comboValue) {
const indexes = comboValue.split(',').map(i => parseInt(i));
const maxIndex = Math.max(...indexes);
return $(.supplier-card[data-card-index="${maxIndex}"]);
}
// MODIFICATA: Applica combinazione con calcolo totale corretto
function applyCombination(color) {
const selectedCombo = $(#combinazione-fornitori-${color}).val();
if (!selectedCombo) {
alert(Seleziona prima una combinazione ${color});
return;
}
   const indexes = selectedCombo.split(',');
   let combinationDetails = [];
   let combinationCardIndexes = indexes.map(i => parseInt(i));
   let totalCombination = 0;
   
   // Raccogli dettagli di ogni fornitore nella combinazione
   indexes.forEach(cardIndex => {
       const card = $(`.supplier-card[data-card-index="${cardIndex}"]`);
       
       const nome = card.find('.nome-fornitore').val();
       const altroNome = card.find('.altro-fornitore').val();
       const supplierNumber = card.data('supplier-number');
       
       let nomeFornitore = '';
       if (nome === 'ALTRO' && altroNome) {
           nomeFornitore = altroNome;
       } else if (nome && nome !== 'ALTRO') {
           nomeFornitore = nome;
       }
       
       const certificazione = card.find('.certificazione').val() || 'N/D';
       const linea = card.find('.linea').val() || 'N/D';
       
       const quantitaTrasformata = parseFloat(card.find('.quantita-trasformata').val()) || 0;
       const resa = fornitoriData[cardIndex]?.resa?.prima || (yieldsPerLine[linea]?.prima || 30);
       
       if (quantitaTrasformata > 0) {
           const risultatoFornitore = (quantitaTrasformata * resa / 100);
           totalCombination += risultatoFornitore;
           
           combinationDetails.push({
               nome: nomeFornitore,
               supplierNumber: supplierNumber,
               certificazione: certificazione,
               linea: linea,
               quantita: quantitaTrasformata,
               resa: resa,
               risultato: risultatoFornitore.toFixed(1),
               cardIndex: parseInt(cardIndex)
           });
       }
   });
   
   const lastCardInCombo = getLastCardInCombination(selectedCombo);
   if (lastCardInCombo.length > 0) {
       const lastCardIndex = lastCardInCombo.data('card-index');
       
       // Trova la quantità del fornitore finale nella combinazione
       const lastCardDetail = combinationDetails.find(d => d.cardIndex === lastCardIndex);
       const lastCardQty = lastCardDetail ? parseFloat(lastCardDetail.risultato) : 0;
       
       const quantitaPrimaField = lastCardInCombo.find('.succo-prima');
       
       // Mostra solo la quantità del fornitore finale
       quantitaPrimaField.val(lastCardQty.toFixed(1));
       quantitaPrimaField.addClass('combination-result');
       quantitaPrimaField.attr('data-combination-type', color);
       
       // Crea i dettagli della combinazione
       const combinationText = combinationDetails.map(detail => 
           `F${detail.supplierNumber}= ${detail.risultato}kg`
       ).join(' + ');
       const totalText = `Totale ${totalCombination.toFixed(1)}kg`;
       
       // Mostra i dettagli sotto il campo succo 1ª
       const combinationDetailsContainer = lastCardInCombo.find('.combination-details');
       combinationDetailsContainer.removeClass('hidden-field');
       combinationDetailsContainer.html(`<strong>Combinazione ${color.charAt(0).toUpperCase() + color.slice(1)}:</strong><br/>${combinationText}<br/><strong>${totalText}</strong>`);
       
       // Applica colori a tutti i fornitori della combinazione
       indexes.forEach(cardIndex => {
           const card = $(`.supplier-card[data-card-index="${cardIndex}"]`);
           card.addClass(`combination-${color}`);
           card.find('.card-header').addClass(`combination-${color}`);
           
           // Aggiorna header con simbolo colore
           const currentHeader = card.find('.card-header').text();
           const colorSymbol = color === 'verde' ? '(V)' : color === 'azzurro' ? '(A)' : '(P)';
           if (!currentHeader.includes('(V)') && !currentHeader.includes('(A)') && !currentHeader.includes('(P)')) {
               card.find('.card-header').html(currentHeader + ' ' + colorSymbol);
           }
       });
       
       // Salva combinazione con totale
       combinationData[color] = {
           indexes: combinationCardIndexes,
           details: combinationDetails,
           totalCombination: totalCombination
       };
       
       updateDestinationCard(lastCardIndex);
       
       const colorText = color.charAt(0).toUpperCase() + color.slice(1);
       alert(`Combinazione ${colorText} applicata!\n\nDettaglio:\n${combinationDetails.map(d => `F${d.supplierNumber} - ${d.nome}: ${d.quantita}kg × ${d.resa}% = ${d.risultato}kg`).join('\n')}\n\nTotale combinazione: ${totalCombination.toFixed(1)} kg\nQuantità F${lastCardDetail.supplierNumber}: ${lastCardQty.toFixed(1)} kg`);
   }
}
function resetCombination(color) {
// Rimuovi colori da tutte le card della combinazione
if (combinationData[color] && combinationData[color].indexes.length > 0) {
combinationData[color].indexes.forEach(cardIndex => {
const card = $(.supplier-card[data-card-index="${cardIndex}"]);
const quantitaPrimaField = card.find('.succo-prima');
const combinationType = quantitaPrimaField.attr('data-combination-type');
           if (combinationType === color) {
               card.removeClass(`combination-${color}`);
               card.find('.card-header').removeClass(`combination-${color}`);
               
               // Rimuovi simbolo colore dall'header
               const currentHeader = card.find('.card-header').html();
               const cleanHeader = currentHeader.replace(/\s*\([VAP]\)/, '');
               card.find('.card-header').html(cleanHeader);
               
               quantitaPrimaField.removeClass('combination-result');
               quantitaPrimaField.removeAttr('data-combination-type');
               
               // Nascondi e reset dettagli combinazione
               card.find('.combination-details').addClass('hidden-field').html('');
               
               // Ricalcola valore normale
               calculateSupplier(cardIndex);
               updateDestinationCard(cardIndex);
           }
       });
   }
   
   $(`#combinazione-fornitori-${color}`).val('');
   
   // Reset dati combinazione
   combinationData[color] = { indexes: [], details: [], totalCombination: 0 };
   
   const colorText = color.charAt(0).toUpperCase() + color.slice(1);
   alert(`Combinazione ${colorText} rimossa. I valori sono stati ricalcolati.`);
}
// NUOVA: Genera tabella per stampa
function generatePrintTable() {
const tbody = $('#print-table-body');
tbody.empty();
   // Ordina le card fornitori per numero
   const supplierCards = $('.supplier-card').toArray().sort((a, b) => {
       const numA = parseInt($(a).data('supplier-number')) || 0;
       const numB = parseInt($(b).data('supplier-number')) || 0;
       return numA - numB;
   });
   
   supplierCards.forEach(card => {
       const $card = $(card);
       const cardIndex = $card.data('card-index');
       const supplierNumber = $card.data('supplier-number');
       
       // Determina colore combinazione
       let combinationClass = '';
       if ($card.hasClass('combination-verde')) combinationClass = 'combination-verde';
       else if ($card.hasClass('combination-azzurro')) combinationClass = 'combination-azzurro';
       else if ($card.hasClass('combination-viola')) combinationClass = 'combination-viola';
       
       // Raccogli dati
       const nome = $card.find('.nome-fornitore').val();
       const altroNome = $card.find('.altro-fornitore').val();
       const nomeFornitore = nome === 'ALTRO' ? altroNome : nome;
       
       const linea = $card.find('.linea').val() || '';
       const entrata = parseFloat($card.find('.quantita-entrata').val()) || 0;
       const trasformata = parseFloat($card.find('.quantita-trasformata').val()) || 0;
       const giacenza = parseFloat($card.find('.giacenza').val()) || 0;
       
       const cert = $card.find('.certificazione').val() || '';
       const altraCert = $card.find('.altra-certificazione').val();
       const certificazione = cert === 'ALTRO' ? altraCert : cert;
       
       const varieta = $card.find('.varieta').val() || '';
       const altraVarieta = $card.find('.altra-varieta').val();
       const varietaFinal = varieta === 'ALTRO' ? altraVarieta : varieta;
       
       const portata = parseFloat($card.find('.portata').val()) || 0;
       const inizio = $card.find('.orario-inizio').val() || '';
       const fine = $card.find('.orario-fine').val() || '';
       const succo = parseFloat($card.find('.succo-prima').val()) || 0;
       
       const dest = $card.find('.destinazione-prima').val() || '';
       const altraDest = $card.find('.altra-destinazione').val();
       const destinazione = dest === 'ALTRO' ? altraDest : dest;
       
       const polpa = $card.find('.tenore-polpa-prima').val() || '';
       const brix = $card.find('.brix-prima').val() || '';
       const bio = $card.find('.bio-prima').val() || '';
       const past = $card.find('.pastorizzato-prima').val() || '';
       const cons = $card.find('.conservato-prima').val() || '';
       const note = $card.find('.note-prima').val() || '';
       
       // Determina stili bio
       const isBio = cert && cert.includes('BIO');
       const isDeclassato = bio === 'DECLASSATO';
       const bioClass = isBio && !isDeclassato ? 'bio-red-text' : (isDeclassato ? 'bio-black-text' : '');
       
       // Crea riga tabella
       const row = `
           <div class="print-table-row ${combinationClass}">
               <div class="print-table-cell ${bioClass}">${linea}</div>
               <div class="print-table-cell ${bioClass}">F${supplierNumber} - ${nomeFornitore || 'N/D'}</div>
               <div class="print-table-cell">${entrata}</div>
               <div class="print-table-cell">${trasformata}</div>
               <div class="print-table-cell">${giacenza}</div>
               <div class="print-table-cell ${bioClass}">${certificazione}</div>
               <div class="print-table-cell ${bioClass}">${varietaFinal}</div>
               <div class="print-table-cell">${portata}</div>
               <div class="print-table-cell">${inizio}</div>
               <div class="print-table-cell">${fine}</div>
               <div class="print-table-cell">${succo.toFixed(1)}</div>
               <div class="print-table-cell ${bioClass}">${destinazione}</div>
               <div class="print-table-cell">${polpa}</div>
               <div class="print-table-cell">${brix}</div>
               <div class="print-table-cell ${bioClass}">${bio}</div>
               <div class="print-table-cell">${past}</div>
               <div class="print-table-cell">${cons}</div>
               <div class="print-table-cell">${note}</div>
           </div>
       `;
       
       tbody.append(row);
   });
}
// Override della funzione di stampa
window.addEventListener('beforeprint', function() {
generatePrintTable();
updatePrintSummary();
});
// MODIFICATA: Reset card
window.resetCard = function(cardIndex) {
if (confirm('Resettare tutti i campi di questa card?')) {
const supplierCard = $(.supplier-card[data-card-index="${cardIndex}"]);
const destCard = $(.destination-card[data-card-index="${cardIndex}"]);
       if (supplierCard.length > 0) {
           // Reset fornitore
           const supplierNumber = supplierCard.data('supplier-number');
           supplierCard.removeClass('combination-verde combination-azzurro combination-viola');
           supplierCard.find('.card-header').removeClass('combination-verde combination-azzurro combination-viola');
           
           // Rimuovi riferimenti dalle combinazioni
           ['verde', 'azzurro', 'viola'].forEach(color => {
               const supplierIndex = combinationData[color].indexes.indexOf(cardIndex);
               if (supplierIndex > -1) {
                   combinationData[color].indexes.splice(supplierIndex, 1);
                   combinationData[color].details = combinationData[color].details.filter(d => d.cardIndex !== cardIndex);
                   combinationData[color].totalCombination = 0;
               }
           });
           
           // Reset quantità trasferite
           delete transferredAmounts[cardIndex];
           
           // Reset tutti i campi
           supplierCard.find('input, select, textarea').val('');
           supplierCard.find('.altro-fornitore, .altra-certificazione, .altra-varieta, .altra-destinazione').addClass('hidden-field');
           supplierCard.find('.succo-prima').removeClass('combination-result received-transfer');
           supplierCard.find('.transfer-details, .combination-details').addClass('hidden-field').html('');
           supplierCard.find('.card-header').text(`Fornitore ${supplierNumber}`);
           
           // Rimuovi dati trasferimenti
           delete transferData[cardIndex];
           
           updateBioStyle(cardIndex);
           
       } else if (destCard.length > 0) {
           // Reset destinazione
           destCard.find('input, select, textarea').val('');
           destCard.find('.altra-destinazione-text, .altro-tenore-text, .altro-brix-text').addClass('hidden-field');
           destCard.find('.bio').val('SI');
           destCard.find('.conservato').val('NO');
           
           // Reset provenienza
           delete provenienzaData[cardIndex];
           $(`#provenienza-${cardIndex}`).text('Nessuna provenienza');
           
           // Reset assegnazione fornitore
           destCard.removeData('selected-supplier');
           destCard.find('.dest-card-header').text('Destinazione non assegnata');
           
           updateDestBioStyles(cardIndex);
       }
       
       updateTotals();
       updateCombinazioneOptions();
       updateTransferOptions();
       updateDestinationHeaders();
       updateSummaryCards();
       
       alert('Card resettata con successo!');
   }
};
// MODIFICATA: Rimuovi card con riorganizzazione automatica
window.removeCard = function(cardIndex) {
if (confirm('Rimuovere questa card?')) {
// Rimuovi riferimenti dalle combinazioni
['verde', 'azzurro', 'viola'].forEach(color => {
const supplierIndex = combinationData[color].indexes.indexOf(cardIndex);
if (supplierIndex > -1) {
combinationData[color].indexes.splice(supplierIndex, 1);
combinationData[color].details = combinationData[color].details.filter(d => d.cardIndex !== cardIndex);
combinationData[color].totalCombination = 0;
}
});
       $(`.supplier-card[data-card-index="${cardIndex}"], .destination-card[data-card-index="${cardIndex}"]`).remove();
       
       // Rimuovi dati
       delete fornitoriData[cardIndex];
       delete destinazioniData[cardIndex];
       delete transferData[cardIndex];
       delete transferredAmounts[cardIndex];
       delete provenienzaData[cardIndex];
       
       // Rimuovi riferimenti a questa card dai trasferimenti di altri
       Object.keys(transferData).forEach(key => {
           transferData[key] = transferData[key].filter(transfer => 
               transfer.fromCard !== cardIndex
           );
       });
       
       // Riorganizza automaticamente con priorità
       reorganizeCardsWithPriority();
       
       updateTotals();
       updateCombinazioneOptions();
       toggleCombinazioniSection();
       updateTransferOptions();
       updateDestinationHeaders();
       updateSummaryCards();
   }
};
// Salvataggio e caricamento file
function collectProgramData() {
const data = {
tipoAgrume: $('#tipo-agrume').val(),
dataLavorazione: $('#data-lavorazione').val(),
ultimaRevisione: $('#last-revision').text(),
transferData: transferData,
transferredAmounts: transferredAmounts,
provenienzaData: provenienzaData,
combinationData: combinationData,
fornitoriData: fornitoriData,
destinazioniData: destinazioniData,
succosecondaData: {
destinazione: $('.destinazione-totale-seconda').val(),
altraDestinazione: $('.altra-dest-seconda').val(),
tenorePolpa: $('.tenore-polpa-seconda').val(),
brix: $('.brix-seconda').val(),
pastorizzato: $('.pastorizzato-seconda').val(),
conservato: $('.conservato-seconda').val(),
note: $('.note-seconda').val()
},
torchiatoData: {
destinazione: $('.destinazione-totale-torchiato').val(),
altraDestinazione: $('.altra-dest-torchiato').val(),
tenorePolpa: $('.tenore-polpa-torchiato').val(),
brix: $('.brix-torchiato').val(),
pastorizzato: $('.pastorizzato-torchiato').val(),
conservato: $('.conservato-torchiato').val(),
note: $('.note-torchiato').val()
},
cards: []
};
   // Raccolta dati fornitori
   $('.supplier-card').each(function() {
       const cardIndex = $(this).data('card-index');
       const supplierNumber = $(this).data('supplier-number');
       const receivedTransfers = transferData[cardIndex] || [];
       
       // Determina colore combinazione
       let combinationColor = '';
       ['verde', 'azzurro', 'viola'].forEach(color => {
           if ($(this).hasClass(`combination-${color}`)) {
               combinationColor = color;
           }
       });
       
       const card = {
           cardIndex: cardIndex,
           cardType: 'supplier',
           supplierNumber: supplierNumber,
           nome: $(this).find('.nome-fornitore').val(),
           altroNome: $(this).find('.altro-fornitore').val(),
           quantitaEntrata: parseFloat($(this).find('.quantita-entrata').val()) || 0,
           quantitaTrasformata: parseFloat($(this).find('.quantita-trasformata').val()) || 0,
           giacenza: parseFloat($(this).find('.giacenza').val()) || 0,
           certificazione: $(this).find('.certificazione').val(),
           altraCertificazione: $(this).find('.altra-certificazione').val(),
           varieta: $(this).find('.varieta').val(),
           altraVarieta: $(this).find('.altra-varieta').val(),
           linea: $(this).find('.linea').val(),
           portata: parseFloat($(this).find('.portata').val()) || 0,
           orarioInizio: $(this).find('.orario-inizio').val(),
           orarioFine: $(this).find('.orario-fine').val(),
           succo: parseFloat($(this).find('.succo-prima').val()) || 0,
           destinazione: $(this).find('.destinazione-prima').val(),
           altraDestinazione: $(this).find('.altra-destinazione').val(),
           tenorePolpa: $(this).find('.tenore-polpa-prima').val(),
           brix: $(this).find('.brix-prima').val(),
           bio: $(this).find('.bio-prima').val(),
           pastorizzato: $(this).find('.pastorizzato-prima').val(),
           conservato: $(this).find('.conservato-prima').val(),
           note: $(this).find('.note-prima').val(),
           hasCombination: $(this).find('.succo-prima').hasClass('combination-result'),
           combinationType: $(this).find('.succo-prima').attr('data-combination-type') || '',
           combinationColor: combinationColor,
           combinationDetails: $(this).find('.combination-details').html() || '',
           hasReceivedTransfers: $(this).find('.succo-prima').hasClass('received-transfer'),
           receivedTransfers: receivedTransfers
       };
       
       data.cards.push(card);
   });
   
   // Raccolta dati destinazioni
   $('.destination-card').each(function() {
       const cardIndex = $(this).data('card-index');
       const selectedSupplier = $(this).data('selected-supplier');
       
       const card = {
           cardIndex: cardIndex,
           cardType: 'destination',
           selectedSupplier: selectedSupplier,
           quantitaPrima: parseFloat($(this).find('.quantita-prima-dest').val()) || 0,
           destinazione: $(this).find('.destinazione-succo').val(),
           altraDestinazioneText: $(this).find('.altra-destinazione-text').val(),
           caratteristiche: {
               tenorePolpa: $(this).find('.tenore-polpa').val(),
               altroTenoreText: $(this).find('.altro-tenore-text').val(),
               brix: $(this).find('.brix').val(),
               altroBrixText: $(this).find('.altro-brix-text').val(),
               bio: $(this).find('.bio').val(),
               pastorizzato: $(this).find('.pastorizzato').val(),
               conservato: $(this).find('.conservato').val(),
               note: $(this).find('.note').val()
           }
       };
       
       data.cards.push(card);
   });
   
   return data;
}
function saveToFile() {
try {
const data = collectProgramData();
const dataString = JSON.stringify(data, null, 2);
       const today = new Date();
       const dateString = today.toISOString().split('T')[0];
       const agrume = data.tipoAgrume || 'programma';
       const filename = `programma_${agrume}_${dateString}.json`;
       
       if ('showSaveFilePicker' in window) {
           saveWithFileSystemAPI(dataString, filename);
       } else {
           saveWithDownloadFallback(dataString, filename);
       }
       
   } catch (error) {
       showSaveStatus('Errore durante la preparazione del file: ' + error.message, 'error');
   }
}
async function saveWithFileSystemAPI(dataString, filename) {
try {
const fileHandle = await window.showSaveFilePicker({
suggestedName: filename,
types: [{
description: 'File JSON',
accept: { 'application/json': ['.json'] }
}]
});
       const writable = await fileHandle.createWritable();
       await writable.write(dataString);
       await writable.close();
       
       showSaveStatus(`File ${filename} salvato con successo!`, 'success');
   } catch (error) {
       if (error.name !== 'AbortError') {
           showSaveStatus('Errore durante il salvataggio: ' + error.message, 'error');
           saveWithDownloadFallback(dataString, filename);
       }
   }
}
function saveWithDownloadFallback(dataString, filename) {
const blob = new Blob([dataString], { type: 'application/json' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = filename;
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);
   showSaveStatus(`File ${filename} salvato nella cartella Download!`, 'success');
}
function loadFromFile() {
$('#file-input').click();
}
$('#file-input').change(function(e) {
const file = e.target.files[0];
if (!file) return;
   if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
       showSaveStatus('Seleziona un file JSON valido', 'error');
       return;
   }
   
   const reader = new FileReader();
   reader.onload = function(e) {
       try {
           const data = JSON.parse(e.target.result);
           loadDataFromObject(data);
           showSaveStatus(`File ${file.name} caricato con successo!`, 'success');
       } catch (error) {
           showSaveStatus('Errore durante il caricamento del file: ' + error.message, 'error');
       }
   };
   reader.readAsText(file);
   
   $(this).val('');
});
function loadDataFromObject(data) {
// Ripristina dati base
$('#tipo-agrume').val(data.tipoAgrume || '');
$('#data-lavorazione').val(data.dataLavorazione || '');
$('#selected-agrume').text(data.tipoAgrume || 'N/D');
   // Ripristina dati globali
   transferData = data.transferData || {};
   transferredAmounts = data.transferredAmounts || {};
   provenienzaData = data.provenienzaData || {};
   combinationData = data.combinationData || { verde: { indexes: [], details: [], totalCombination: 0 }, azzurro: { indexes: [], details: [], totalCombination: 0 }, viola: { indexes: [], details: [], totalCombination: 0 } };
   fornitoriData = data.fornitoriData || {};
   destinazioniData = data.destinazioniData || {};
   
   // Ripristina dati succo 2ª e torchiato
   if (data.succosecondaData) {
       $('.destinazione-totale-seconda').val(data.succosecondaData.destinazione || 'NAT IN TINI');
       $('.altra-dest-seconda').val(data.succosecondaData.altraDestinazione || '');
       $('.tenore-polpa-seconda').val(data.succosecondaData.tenorePolpa || '<1%');
       $('.brix-seconda').val(data.succosecondaData.brix || 'NAT');
       $('.pastorizzato-seconda').val(data.succosecondaData.pastorizzato || 'SI');
       $('.conservato-seconda').val(data.succosecondaData.conservato || 'SI');
       $('.note-seconda').val(data.succosecondaData.note || 'SERB. ESTERNI');
   }
   
   if (data.torchiatoData) {
       $('.destinazione-totale-torchiato').val(data.torchiatoData.destinazione || 'CONCENTRATO');
       $('.altra-dest-torchiato').val(data.torchiatoData.altraDestinazione || '');
       $('.tenore-polpa-torchiato').val(data.torchiatoData.tenorePolpa || '<1%');
       $('.brix-torchiato').val(data.torchiatoData.brix || '45');
       $('.pastorizzato-torchiato').val(data.torchiatoData.pastorizzato || 'SI');
       $('.conservato-torchiato').val(data.torchiatoData.conservato || 'NO');
       $('.note-torchiato').val(data.torchiatoData.note || '');
   }
   
   // Pulisci container pagine
   $('#pages-container').empty();
   initializePagesContainer();
   
   // Ripristina cards nell'ordine corretto
   if (data.cards && data.cards.length > 0) {
       // Ordina per cardIndex
       data.cards.sort((a, b) => a.cardIndex - b.cardIndex);
       
       data.cards.forEach((cardData) => {
           const cardIndex = cardData.cardIndex;
           const position = getNextAvailablePosition();
           
           if (cardData.cardType === 'supplier') {
               const supplierNumber = cardData.supplierNumber || cardIndex;
               const newCard = createSupplierCard(cardIndex, supplierNumber);
               
               // Aggiungi alla pagina corretta
               const currentPage = $(`.main-grid[data-page="${position.pageIndex + 1}"]`);
               if (currentPage.length === 0) {
                   createNewPage();
               }
               $(`.main-grid[data-page="${position.pageIndex + 1}"]`).append(newCard);
               
               const card = $(`.supplier-card[data-card-index="${cardIndex}"]`);
               card.addClass(`card-position-${position.position}`);
               
               // Ripristina tutti i dati del fornitore
               card.find('.nome-fornitore').val(cardData.nome || '');
               card.find('.altro-fornitore').val(cardData.altroNome || '');
               card.find('.quantita-entrata').val(cardData.quantitaEntrata || '');
               card.find('.quantita-trasformata').val(cardData.quantitaTrasformata || '');
               card.find('.giacenza').val(cardData.giacenza || '');
               card.find('.certificazione').val(cardData.certificazione || '');
               card.find('.altra-certificazione').val(cardData.altraCertificazione || '');
               card.find('.varieta').val(cardData.varieta || '');
               card.find('.altra-varieta').val(cardData.altraVarieta || '');
               card.find('.linea').val(cardData.linea || '');
               card.find('.portata').val(cardData.portata || '');
               card.find('.orario-inizio').val(cardData.orarioInizio || '');
               card.find('.orario-fine').val(cardData.orarioFine || '');
               card.find('.succo-prima').val(cardData.succo || '');
               card.find('.destinazione-prima').val(cardData.destinazione || '');
               card.find('.altra-destinazione').val(cardData.altraDestinazione || '');
               card.find('.tenore-polpa-prima').val(cardData.tenorePolpa || 'STANDARD');
               card.find('.brix-prima').val(cardData.brix || 'NAT');
               card.find('.bio-prima').val(cardData.bio || 'SI');
               card.find('.pastorizzato-prima').val(cardData.pastorizzato || 'SI');
               card.find('.conservato-prima').val(cardData.conservato || 'NO');
               card.find('.note-prima').val(cardData.note || '');
               
               // Gestisci campi altro
               if (cardData.nome === 'ALTRO') {
                   card.find('.altro-fornitore').removeClass('hidden-field');
               }
               if (cardData.certificazione === 'ALTRO') {
                   card.find('.altra-certificazione').removeClass('hidden-field');
               }
               if (cardData.varieta === 'ALTRO') {
                   card.find('.altra-varieta').removeClass('hidden-field');
               }
               if (cardData.destinazione === 'ALTRO') {
                   card.find('.altra-destinazione').removeClass('hidden-field');
               }
               
               // Ripristina combinazioni
               if (cardData.hasCombination) {
                   card.find('.succo-prima').addClass('combination-result');
                   if (cardData.combinationType) {
                       card.find('.succo-prima').attr('data-combination-type', cardData.combinationType);
                   }
               }
               
               if (cardData.combinationColor) {
                   card.addClass(`combination-${cardData.combinationColor}`);
                   card.find('.card-header').addClass(`combination-${cardData.combinationColor}`);
               }
               
               if (cardData.combinationDetails) {
                   card.find('.combination-details').removeClass('hidden-field').html(cardData.combinationDetails);
               }
               
               // Ripristina trasferimenti
               if (cardData.hasReceivedTransfers) {
                   card.find('.succo-prima').addClass('received-transfer');
               }
               
               updateSupplier(cardIndex);
               
           } else if (cardData.cardType === 'destination') {
               const newCard = createDestinationCard(cardIndex, cardData.selectedSupplier);
               
               // Aggiungi alla pagina corretta
               const currentPage = $(`.main-grid[data-page="${position.pageIndex + 1}"]`);
               if (currentPage.length === 0) {
                   createNewPage();
               }
               $(`.main-grid[data-page="${position.pageIndex + 1}"]`).append(newCard);
               
               const card = $(`.destination-card[data-card-index="${cardIndex}"]`);
               card.addClass(`card-position-${position.position}`);
               
               // Imposta fornitore selezionato
               if (cardData.selectedSupplier) {
                   card.data('selected-supplier', cardData.selectedSupplier);
               }
               
               // Ripristina dati destinazione
               card.find('.quantita-prima-dest').val(cardData.quantitaPrima || '');
               card.find('.destinazione-succo').val(cardData.destinazione || '');
               card.find('.altra-destinazione-text').val(cardData.altraDestinazioneText || '');
               
               if (cardData.caratteristiche) {
                   const car = cardData.caratteristiche;
                   card.find('.tenore-polpa').val(car.tenorePolpa || 'STANDARD');
                   card.find('.altro-tenore-text').val(car.altroTenoreText || '');
                   card.find('.brix').val(car.brix || 'NAT');
                   card.find('.altro-brix-text').val(car.altroBrixText || '');
                   card.find('.bio').val(car.bio || 'SI');
                   card.find('.pastorizzato').val(car.pastorizzato || 'SI');
                   card.find('.conservato').val(car.conservato || 'NO');
                   card.find('.note').val(car.note || '');
               }
               
               // Gestisci campi altro
               if (cardData.destinazione === 'ALTRO') {
                   card.find('.altra-destinazione-text').removeClass('hidden-field');
               }
               if (cardData.caratteristiche?.tenorePolpa === 'ALTRO') {
                   card.find('.altro-tenore-text').removeClass('hidden-field');
               }
               if (cardData.caratteristiche?.brix === 'ALTRO') {
                   card.find('.altro-brix-text').removeClass('hidden-field');
               }
               
               // Ripristina provenienza
               if (provenienzaData[cardIndex]) {
                   const provenienzaText = provenienzaData[cardIndex]
                       .map(p => `${p.fornitore}: ${p.quantita}kg`)
                       .join(', ');
                   $(`#provenienza-${cardIndex}`).text(`Provenienza: ${provenienzaText}`);
               }
               
               updateDestBioStyles(cardIndex);
           }
       });
   }
   
   // Riorganizza con priorità dopo il caricamento
   reorganizeCardsWithPriority();
   
   // Aggiorna tutto
   updateTotals();
   updateElementsCount();
   updateCombinazioneOptions();
   toggleCombinazioniSection();
   updateTransferOptions();
   updateDestinationHeaders();
   updateSummaryCards();
   
   // Aggiorna varietà
   const agrume = $('#tipo-agrume').val();
   if (agrume && varietyOptions[agrume]) {
       $('.varieta').each(function() {
           const current = $(this).val();
           $(this).empty().append('<option value="">Seleziona varietà</option>');
           varietyOptions[agrume].forEach(variety => {
               $(this).append(`<option value="${variety}">${variety}</option>`);
           });
           $(this).val(current);
       });
   }
   
   showSaveStatus('Dati caricati con successo!', 'success');
}
function showSaveStatus(message, type) {
const statusDiv = $('#save-status');
const messageSpan = $('#save-message');
   messageSpan.text(message);
   
   if (type === 'error') {
       statusDiv.addClass('save-error').removeClass('save-status');
   } else {
       statusDiv.removeClass('save-error').addClass('save-status');
   }
   
   statusDiv.fadeIn();
   
   setTimeout(() => {
       statusDiv.fadeOut();
   }, 3000);
}
// Eventi principali
$('#tipo-agrume').change(function() {
const agrume = $(this).val();
$('#selected-agrume').text(agrume || 'N/D');
   // Aggiorna varietà in tutte le card esistenti
   if (agrume && varietyOptions[agrume]) {
       $('.varieta').each(function() {
           const current = $(this).val();
           $(this).empty().append('<option value="">Seleziona varietà</option>');
           varietyOptions[agrume].forEach(variety => {
               $(this).append(`<option value="${variety}">${variety}</option>`);
           });
           $(this).val(current);
       });
   }
   
   // Ricalcola tutti i fornitori
   $('.supplier-card').each(function() {
       const cardIndex = $(this).data('card-index');
       calculateSupplier(cardIndex);
       updateDestinationCard(cardIndex);
   });
   
   updateTotals();
   updateSummaryCards();
});
$('#aggiungi-fornitore').click(function() {
if (!$('#tipo-agrume').val()) {
alert('Seleziona prima il tipo di agrume');
return;
}
   const position = getNextAvailablePosition();
   const cardIndex = getNextCardIndex();
   const supplierNumber = getNextSupplierNumber();
   const newCard = createSupplierCard(cardIndex, supplierNumber);
   
   // Aggiungi alla pagina corretta
   const currentPage = $(`.main-grid[data-page="${position.pageIndex + 1}"]`);
   if (currentPage.length === 0) {
       createNewPage();
   }
   $(`.main-grid[data-page="${position.pageIndex + 1}"]`).append(newCard);
   
   // Aggiungi la classe di posizione
   $(`.supplier-card[data-card-index="${cardIndex}"]`).addClass(`card-position-${position.position}`);
   
   updateElementsCount();
   updateCombinazioneOptions();
   toggleCombinazioniSection();
   updateTransferOptions();
   updateDestinationHeaders();
});
// Gestione aggiunta destinazione con selezione fornitore
$('#aggiungi-destinazione').click(async function() {
try {
const position = getNextAvailablePosition();
       // Mostra modal per selezione fornitore
       const selectedSupplier = await showSupplierSelectionModal();
       
       const cardIndex = getNextCardIndex();
       const newCard = createDestinationCard(cardIndex, selectedSupplier);
       
       // Aggiungi alla pagina corretta
       const currentPage = $(`.main-grid[data-page="${position.pageIndex + 1}"]`);
       if (currentPage.length === 0) {
           createNewPage();
       }
       $(`.main-grid[data-page="${position.pageIndex + 1}"]`).append(newCard);
       
       // Aggiungi la classe di posizione
       const card = $(`.destination-card[data-card-index="${cardIndex}"]`);
       card.addClass(`card-position-${position.position}`);
       card.data('selected-supplier', selectedSupplier);
       
       updateElementsCount();
       updateTransferOptions();
       updateDestinationHeaders();
       
   } catch (error) {
       if (error !== 'Operazione annullata') {
           alert(error);
       }
   }
});
// Eventi combinazioni
$('#applica-combinazione-verde').click(function() {
applyCombination('verde');
});
$('#reset-combinazione-verde').click(function() {
resetCombination('verde');
});
$('#applica-combinazione-azzurro').click(function() {
applyCombination('azzurro');
});
$('#reset-combinazione-azzurro').click(function() {
resetCombination('azzurro');
});
$('#applica-combinazione-viola').click(function() {
applyCombination('viola');
});
$('#reset-combinazione-viola').click(function() {
resetCombination('viola');
});
// Eventi salvataggio e caricamento
$('#salva-file').click(function() {
saveToFile();
});
$('#carica-file').click(function() {
if (confirm('Attenzione: il caricamento del file sovrascriverà tutti i dati attuali. Continuare?')) {
loadFromFile();
}
});
$('#reset-tutto').click(function() {
if (confirm('Attenzione: questa operazione cancellerà tutti i dati inseriti. Continuare?')) {
location.reload();
}
});
// Gestione eventi dinamici per campi "ALTRO"
$(document).on('change', '.certificazione', function() {
const card = $(this).closest('.supplier-card');
const cardIndex = card.data('card-index');
const cert = $(this).val();
const altroField = card.find('.altra-certificazione');
   if (cert === 'ALTRO') {
       altroField.removeClass('hidden-field');
   } else {
       altroField.addClass('hidden-field').val('');
   }
   
   updateBioStyle(cardIndex);
});
// Gestione eventi dinamici per card riepilogo
$(document).on('change', '.destinazione-totale-seconda, .destinazione-totale-torchiato', function() {
const card = $(this).closest('.summary-card-footer, .torchiato-card-footer');
const dest = $(this).val();
const altroField = card.find('.altra-dest-seconda, .altra-dest-torchiato');
   if (dest === 'ALTRO') {
       altroField.removeClass('hidden-field');
   } else {
       altroField.addClass('hidden-field').val('');
   }
   
   updatePrintSummary();
});
$(document).on('change', '.tenore-polpa-seconda, .tenore-polpa-torchiato', function() {
const card = $(this).closest('.summary-card-footer, .torchiato-card-footer');
const tenore = $(this).val();
const altroField = card.find('.altro-tenore-seconda, .altro-tenore-torchiato');
   if (tenore === 'ALTRO') {
       altroField.removeClass('hidden-field');
   } else {
       altroField.addClass('hidden-field').val('');
   }
   
   updatePrintSummary();
});
$(document).on('change', '.brix-seconda, .brix-torchiato', function() {
const card = $(this).closest('.summary-card-footer, .torchiato-card-footer');
const brix = $(this).val();
const altroField = card.find('.altro-brix-seconda, .altro-brix-torchiato');
   if (brix === 'ALTRO') {
       altroField.removeClass('hidden-field');
   } else {
       altroField.addClass('hidden-field').val('');
   }
   
   updatePrintSummary();
});
// Altri eventi dinamici per destinazioni
$(document).on('change', '.destinazione-succo', function() {
const card = $(this).closest('.destination-card');
const cardIndex = card.data('card-index');
toggleAltroDestinazione(cardIndex);
updateDestBioStyles(cardIndex);
});
$(document).on('change', '.tenore-polpa', function() {
const card = $(this).closest('.destination-card');
const cardIndex = card.data('card-index');
toggleAltroTenore(cardIndex);
});
$(document).on('change', '.brix', function() {
const card = $(this).closest('.destination-card');
const cardIndex = card.data('card-index');
toggleAltroBrix(cardIndex);
});
$(document).on('input', '.quantita-prima-dest', function() {
const card = $(this).closest('.destination-card');
const cardIndex = card.data('card-index');
updateDestBioStyles(cardIndex);
});
$(document).on('change', '.bio', function() {
const card = $(this).closest('.destination-card');
const cardIndex = card.data('card-index');
updateDestBioStyles(cardIndex);
});
// Aggiorna riepilogo quando cambiano i valori
$(document).on('change', '.summary-card-footer input, .summary-card-footer select, .summary-card-footer textarea, .torchiato-card-footer input, .torchiato-card-footer select, .torchiato-card-footer textarea', function() {
updatePrintSummary();
});
// Auto-save ogni 30 secondi
setInterval(function() {
const hasData = $('.supplier-card, .destination-card').length > 0;
if (hasData) {
try {
const data = collectProgramData();
localStorage.setItem('autoSaveData', JSON.stringify(data));
console.log('Auto-save completato');
} catch (error) {
console.log('Errore auto-save:', error);
}
}
}, 30000);
// Ripristino auto-save all'avvio
function checkAutoSave() {
const autoSaveData = localStorage.getItem('autoSaveData');
if (autoSaveData) {
if (confirm('Trovati dati salvati automaticamente. Vuoi ripristinarli?')) {
try {
const data = JSON.parse(autoSaveData);
loadDataFromObject(data);
showSaveStatus('Dati auto-salvati ripristinati', 'success');
} catch (error) {
console.log('Errore ripristino auto-save:', error);
localStorage.removeItem('autoSaveData');
}
} else {
localStorage.removeItem('autoSaveData');
}
}
}
// Gestione chiusura pagina
window.addEventListener('beforeunload', function(e) {
const hasUnsavedData = $('.supplier-card, .destination-card').length > 0;
if (hasUnsavedData) {
e.preventDefault();
e.returnValue = 'Ci sono dati non salvati. Vuoi davvero uscire?';
}
});
// Gestione tasti scorciatoia
$(document).keydown(function(e) {
if (e.ctrlKey) {
switch(e.which) {
case 83: // Ctrl+S - Salva
e.preventDefault();
saveToFile();
break;
case 79: // Ctrl+O - Apri
e.preventDefault();
$('#carica-file').click();
break;
case 80: // Ctrl+P - Stampa
e.preventDefault();
window.print();
break;
case 78: // Ctrl+N - Nuovo fornitore
e.preventDefault();
$('#aggiungi-fornitore').click();
break;
case 77: // Ctrl+M - Nuova destinazione
e.preventDefault();
$('#aggiungi-destinazione').click();
break;
}
}
});
// Controllo validità dati
function validateData() {
let isValid = true;
let errors = [];
   $('.supplier-card').each(function() {
       const cardIndex = $(this).data('card-index');
       const supplierNumber = $(this).data('supplier-number');
       const nome = $(this).find('.nome-fornitore').val();
       const entrata = parseFloat($(this).find('.quantita-entrata').val()) || 0;
       const trasformata = parseFloat($(this).find('.quantita-trasformata').val()) || 0;
       
       if (!nome) {
           errors.push(`F${supplierNumber}: Nome fornitore mancante`);
           isValid = false;
       }
       
       if (trasformata > entrata) {
           errors.push(`F${supplierNumber}: Quantità trasformata superiore all'entrata`);
           isValid = false;
       }
   });
   
   if (!$('#tipo-agrume').val()) {
       errors.push('Tipo di agrume non selezionato');
       isValid = false;
   }
   
   if (!$('#data-lavorazione').val()) {
       errors.push('Data di lavorazione non inserita');
       isValid = false;
   }
   
   if (!isValid) {
       alert('Errori di validazione:\n' + errors.join('\n'));
   }
   
   return isValid;
}
// Override del salvataggio con validazione
const originalSaveToFile = saveToFile;
saveToFile = function() {
if (validateData()) {
originalSaveToFile();
}
};
// Controllo responsive per mobile
function checkMobileView() {
if (window.innerWidth < 768) {
$('.main-grid').css('grid-template-columns', 'repeat(2, 1fr)');
alert('Per una migliore esperienza su dispositivi mobili, si consiglia di ruotare il dispositivo in modalità landscape.');
}
}
// Inizializzazione completa
initApp();
checkAutoSave();
checkMobileView();
// Event listener per il ridimensionamento finestra
$(window).resize(function() {
checkMobileView();
});
console.log('Sistema Programma Giornaliero Trasformazione inizializzato - VERSIONE TABELLARE');
console.log('Modifiche implementate:');
console.log('- Layout tabellare per la stampa');
console.log('- Card Succo 2ª e Torchiato integrate nella parte bassa');
console.log('- Eliminati pulsanti separati per Succo 2ª e Torchiato');
console.log('- Mantenuta colorazione BIO e combinazioni nella stampa');
console.log('- Arrotondamento al quarto d'ora superiore per orari');
console.log('Tasti scorciatoia: Ctrl+S (Salva), Ctrl+O (Apri), Ctrl+P (Stampa), Ctrl+N (Nuovo Fornitore), Ctrl+M (Nuova Destinazione)');
});
</script>
</body>
</html>
```
